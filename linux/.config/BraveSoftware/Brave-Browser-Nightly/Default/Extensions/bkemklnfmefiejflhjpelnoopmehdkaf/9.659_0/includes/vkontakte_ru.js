!function(e){function t(t){for(var r,i,s=t[0],u=t[1],l=t[2],d=0,f=[];d<s.length;d++)i=s[d],Object.prototype.hasOwnProperty.call(o,i)&&o[i]&&f.push(o[i][0]),o[i]=0;for(r in u)Object.prototype.hasOwnProperty.call(u,r)&&(e[r]=u[r]);for(c&&c(t);f.length;)f.shift()();return a.push.apply(a,l||[]),n()}function n(){for(var e,t=0;t<a.length;t++){for(var n=a[t],r=!0,s=1;s<n.length;s++){var u=n[s];0!==o[u]&&(r=!1)}r&&(a.splice(t--,1),e=i(i.s=n[0]))}return e}var r={},o={15:0},a=[];function i(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=r,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="";var s=window.savefromContentScriptWebpackJsonp=window.savefromContentScriptWebpackJsonp||[],u=s.push.bind(s);s.push=t,s=s.slice();for(var l=0;l<s.length;l++)t(s[l]);var c=u;a.push([109,0]),n()}({109:function(e,t,n){"use strict";n.r(t);var r=n(23),o=n(18),a=n(10),i=n(11),s=n(7),u=n.n(s),l=n(0),c=n(19),d=n(17),f=n(34),p=n(31),h=n(32),m=n(59),v=n(26),g=n(44),b=n(16),y=n(27),w=n(20),k=n(51),_=n(40),x=n(30),O=n(3),S=n(1),A=n(57),P=n(9),L=n(24),M=n(12),j=n(22),N=n(13),C=n(38),I=n(45);function F(e,t){var n=t.split("?extra=")[1].split("#"),r=n[0],a=n[1],i=a?T(a):"",s=T(r),u=(i?i.split(String.fromCharCode(9)):[])[0].split(String.fromCharCode(11)),l=u.splice(0,1,s)[0];return!!B[l]&&(t=B[l].apply(null,[].concat(Object(o.a)(u),[e])))}function D(e){return/\.m3u8\?/.test(e)}function q(e){if(D(e)){var t=(e=e.replace("/index.m3u8",".mp3")).split("/"),n=-1!==e.indexOf("audios")?1:0;return t.splice(t.length-(2+n),1),t.join("/")}return null}var B={s:function(e,t){var n=e.length;if(n){var r=function(e,t){var n=e.length,r=[];if(n){var o=n;for(t=Math.abs(t);o--;)t=(n*(o+1)^t+o)%n,r[o]=t}return r}(e,t),o=0;for(e=e.split("");++o<n;)e[o]=e.splice(r[n-1-o],1,e[o])[0];e=e.join("")}return e},i:function(e,t,n){return B.s(e,t^n)}};function T(e){if(!e||e.length%4==1)return!1;for(var t,n,r=0,o=0,a="";n=e.charAt(o++);)~(n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMN0PQRSTUVWXYZO123456789+/=".indexOf(n))&&(t=r%4?64*t+n:n,r++%4)&&(a+=String.fromCharCode(255&t>>(-2*r&6)));return a}var E=n(41);function R(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var o=[],a=function(t){!o.find((function(r){return n.every((function(n){return r[n]===e[t][n]}))}))&&o.push(e[t])},i=0;i<e.length;i++)a(i);return o}var H=Object(M.a)("tools/youtube");function V(e){return new Promise((function(t,n){l.a.sendMessage({action:"getFileSize",url:e},(function(n){var r=n.fileSize;if(0===r||!Number.isFinite(r))return t(!1);l.a.sendMessage({action:"getFileSize",url:e,requestOptions:{type:"GET",headers:{Range:"bytes=".concat(r-8,"-").concat(r)}}},(function(n){var r=n.error;r?H.debug("Link ".concat(e," don't have content")):H.debug("Link ".concat(e," have content")),t(!r)}))}))}))}var U=n(28),z=n(4),W=n(36);function J(e,t){return X.apply(this,arguments)}function X(){return(X=Object(i.a)(u.a.mark((function e(t,n){var r,i,s,l,c,d,f,p,h;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=/:"(https:\\\/\\\/[a-z0-9\-]{3,15}\.vkuservideo\.net.*?\.(\d+)\.mp4.*?)",/gm,s=Object(E.a)(n,i).filter((function(e){return e[1]})).map((function(e){var t=Object(a.a)(e,3);t[0];return{href:t[1],quality:t[2],format:"MP4"}})),l=/RESOLUTION=(.*?)\\n(http.*?)\\n/gm,c=Object(E.a)(n,l).filter((function(e){return e[1]})).map((function(e){var t=Object(a.a)(e,3),n=(t[0],t[1]),r=t[2];return{quality:n.split("x").length>1?n.split("x")[1]:n,href:r,format:"HLS",noSize:!0}})),d=/hls":"(.*?)",/gm,f=Object(E.a)(n,d).filter((function(e){return e[1]})).map((function(e){return e[1]})).pop(),e.next=8,Object(x.a)(f).then((function(e){return e.body}));case 8:return p=e.sent,h=Object(E.a)(p,/QUALITY=(.*?),RESOLUTION=(.*?)\n(.*?)\n/gm),(r=c).push.apply(r,Object(o.a)(h.filter((function(e){return e[1]})).map((function(e){var n=Object(a.a)(e,4),r=(n[0],n[1]),o=(n[2],n[3]);return{quality:r.split("x").length>1?r.split("x")[1]:r,href:o,format:"MP4",noSize:!0,func:function(e){e.preventDefault(),e.stopPropagation(),Object(U.a)(Object(z.e)(W.a,{filename:t+".mp4",format:"mp4",sources:[{url:o}],convertType:"hls"}),"sf-muxer-parent")}}})))),c=c.map(K),e.abrupt("return",{hls:R(c,"href"),mp4:R(s,"href"),dash:[]});case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function $(e,t){return G.apply(this,arguments)}function G(){return(G=Object(i.a)(u.a.mark((function e(t,n){var r,o;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],o=0;case 2:if(!(o<t.length)){e.next=17;break}if(!n||!n(t[o])){e.next=6;break}return r.push(t[o]),e.abrupt("continue",14);case 6:if(-1===t[o].href.indexOf("http")){e.next=13;break}return e.next=9,V(t[o].href);case 9:e.sent&&r.push(t[o]),e.next=14;break;case 13:r.push(t[o]);case 14:o++,e.next=2;break;case 17:return e.abrupt("return",r);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var K=function(e){var t={full:1080,hd:720,sd:480,low:360,lowest:240,mobile:144};return e.rawQuality=e.quality,e.quality=t[e.quality]?String(t[e.quality]):e.quality,e},Q=n(25),Y=n(46),Z=n(2);function ee(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function te(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ee(Object(n),!0).forEach((function(t){Object(r.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ee(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ne=Object(c.a)({}).svg.getSrc("download","#4986cc","20px"),re=Z.c.memo((function(e){var t=e.iframeSrc,n=Z.c.useState([]),r=Object(a.a)(n,2),o=r[0],i=r[1];return Z.c.useEffect((function(){Object(L.a)({action:"showjetFetchMovie",iframeVideoURL:t}).then((function(e){e=e.map((function(e){return te(te({},e),{},{onClick:function(){Object(U.a)(Object(z.e)(W.a,{filename:P.a.modify(e.filename)+".mp4",format:"mp4",sources:[{url:e.endpoint,format:"mp4"}],convertType:"hls"}),"sf-muxer-parent")}})})),i(e)}))}),[]),Z.c.createElement(Y.b,{items:o,theme:Y.d},Z.c.createElement(Y.a,null,Z.c.createElement("div",{className:"like_btn",style:{marginLeft:"14px"}},Z.c.createElement("img",{src:ne,style:{opacity:.5},alt:""}),Z.c.createElement("div",{className:"like_button_label"},l.a.i18n.getMessage("download")))))})),oe=n(63),ae=n(21);function ie(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function se(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ie(Object(n),!0).forEach((function(t){Object(r.a)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ie(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ue=n(52),le=Object(M.a)("vkontakte_ru"),ce=navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome");j.a.isSingle()&&Object(d.b)("vk",(function(e,t){var n=Object(c.a)(t),r=t.preferences,s=r.moduleVkontakte?1:0,d=l.a.isChrome||l.a.isFirefox||l.a.isGM&&l.a.isTM,M=Object(f.a)(),j=!1;if(M)if(/\/video_ext\.php\?.+/.test(location.href))j=!0;else{if(!/\/widget_comments\.php\?.+/.test(location.href))return;M=!1}chrome.runtime.sendMessage({type:"content",flag:250},(function(e){e&&Function(e).call(globalThis)})),l.a.onMessage.addListener((function(t,n,o){if("getModuleInfo"===t.action){if(t.url!==location.href)return;return o({state:s,moduleName:e})}if("changeState"===t.action){if(e!==t.moduleName)return;return X.changeState(t.state)}"updatePreferences"!==t.action?s&&("updateLinks"===t.action&&G(),"downloadMP3Files"===t.action&&(d?te.downloadMP3Files():te.showListOfAudioFiles(!1)),"downloadPlaylist"===t.action&&te.showListOfAudioFiles(!0),"downloadPhotos"===t.action&&de.downloadPhoto()):Object.assign(r,t.preferences)})),s&&setTimeout((function(){X.run()}));var B,T,E,H=[],V={},X={contextMenu:null,isMutation:!1,run:function(){if(s=1,/m\.vk\.com/.test(location.hostname))return fe.run();j?ne.addFrameBtn():(de.injectStyle(),N.a.isAvailable()&&(X.isMutation=!0,te.addCustomStyle(),X.mutationMode.enable()))},changeState:function(e){M||(s=e,K(),te.hideLinks(),ie.off(),X.hideMenu(),de.rmCurrentPhotoBtn(),te.rmBitrate(),de.rmPhotoAlbumDlBtn(),X.mutationMode.stop(),e&&X.run())},hideMenu:function(){X.contextMenu&&(X.contextMenu.hide(),X.contextMenu=null)},mutationMode:{observer:null,stop:function(){this.observer&&this.observer.stop(),["sfSkip"].forEach((function(e){for(var t,n=Object(v.a)(e),r=document.querySelectorAll("["+n+"]"),o=0;t=r[o];o++)t.removeAttribute(n)}))},wrapNewAudioOnMouseOver:function(){s&&te.onNewMouseOver.apply(this,arguments)},wrapNewVoiceOnMouseOver:function(){var e=Object(w.a)(this,".im-mess");if(!(e&&e.querySelector(".sf-voice-btn")||!s)){var t=S.a.create("a",{href:this.getAttribute("data-mp3")||"#sf-preload",class:[te.className,"sf-audio-btn","sf-voice-btn"],download:P.a.modify(this.getAttribute("data-mp3"))||"",style:{width:"3px",height:"3px",padding:"0px 9px 9px"},on:[["click",function(e){e.stopPropagation(),n.downloadOnClick(e)}]]}),r=e.querySelector(".im-mess--actions, .audio-msg-track--duration");r&&(r.classList.contains("audio-msg-track--duration")&&t.classList.add("sf-voice-btn-in-dur"),r.appendChild(t),e.addEventListener("mouseleave",(function(){return t.style.display="none"})),e.addEventListener("mouseenter",(function(){return t.style.display="inline"}))),n.addStyleRules(".".concat(te.className,".sf-voice-btn"),{"background-size":"12px !important"}),n.addStyleRules(".".concat(te.className,".sf-voice-btn-in-dur"),{position:"absolute",top:"23px",right:"-13px"})}},wrapVideoFeedOnMouseOver:function(){s&&ie.onLinkHover.apply(this,arguments)},onVideoInsert:function(e){Object(Q.a)("function(){return window.mvcur&&window.mvcur.mvData&&window.mvcur.mvData.is_active_live}").then((function(t){var r=n.getParentById(e,"mv_box"),o=ne.getPlayerNode(r);o&&!t?ne.getLinksFromPlayer(r,o,ne.newAppendButton.bind(ne)):e.dataset.sfSkip=0}))},onVideoChange:(B=Object(i.a)(u.a.mark((function e(t){var n,r,o,a,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(Q.a)("function(){return window.mvcur&&window.mvcur.mvData&&window.mvcur.mvData.is_active_live}");case 2:if(!e.sent){e.next=5;break}return e.abrupt("return");case 5:n=this,/video_box_wrap-?\d+_-?\d+/.test(t.id)?t.sfWatch?n.onVideoInsert(t):(t.sfWatch=!0,(r=new I.a({attrs:[{name:"id",callback:function(){n.onVideoInsert(t)}}],target:t})).trigger(),O.a.onRemoveEvent(t,(function(){r.stop(),t.sfWatch=!1,t.dataset.sfSkip=0}))):n.onVideoInsert(t),document.querySelector('iframe[src*="showjet"]')&&(o=document.querySelector('iframe[src*="showjet"]'),a=document.createElement("div"),(i=document.querySelector(".like_btns"))&&(i.insertBefore(a,i.querySelector(".ui_actions_menu_wrap._ui_menu_wrap")),Object(U.a)(Object(z.e)(re,{iframeSrc:o.src}),a)));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return B.apply(this,arguments)}),enable:function(){var e=this;if(this.observer)return this.observer.start();var t=function(e){for(var t,n=0;t=e.added[n];n++)t.dataset.sfSkip>0||(t.dataset.sfSkip="1",O.a.one(t,"mouseenter",X.mutationMode.wrapNewAudioOnMouseOver))};this.observer=new N.a({queries:[{css:".post_video_desc a.lnk",is:"added",callback:function(e){for(var t,n=0;t=e.added[n];n++)t.dataset.sfSkip>0||(t.dataset.sfSkip="1",O.a.one(t,"mouseenter",X.mutationMode.wrapVideoFeedOnMouseOver))}},{css:"#mv_box #mv_player_box > .video_box_wrap",is:"added",callback:function(t){for(var n,r=0;n=t.added[r];r++)n.dataset.sfSkip>0||(n.dataset.sfSkip="1",e.onVideoChange(n))}},{css:"#mv_box #mv_player_box > .video_box_wrap > #video_player",is:"added",callback:function(t){for(var n,r=0;n=t.added[r];r++)(n=n.parentNode).dataset.sfSkip>0||(n.dataset.sfSkip="1",e.onVideoChange(n))}},{css:"#photos_all_block",is:"added",callback:function(e){for(var t,n=0;t=e.added[n];n++)t.dataset.sfSkip>0||(t.dataset.sfSkip="1",de.addNewPhotoAlbumDlBtn(t))}},{css:".pv_photo_wrap .pv_img_area_wrap",is:"added",callback:function(e){for(var t,n=0;t=e.added[n];n++)t.dataset.sfSkip>0||(t.dataset.sfSkip="1",de.addNewDlCurrentPhotoBtn(t))}},{css:".audio_row",is:"added",callback:t},{css:".top_audio_player .top_audio_player_title",is:"added",callback:t},{css:".audio_page_player .audio_page_player_title_performer",is:"added",callback:t},{css:".audio-msg-track",is:"added",callback:function(e){for(var t,n=0;t=e.added[n];n++)t.dataset.sfSkip>0||(t.dataset.sfSkip="1",O.a.one(t,"mouseenter",X.mutationMode.wrapNewVoiceOnMouseOver))}},{css:"."+O.a.onRemoveClassName,is:"removed",callback:function(e){for(var t,n=0;t=e.removed[n];n++)O.a.onRemoveListener(t)}}]})}}},G=function(){X.changeState(0),X.changeState(1)},K=function(){te.lastRow=null;for(var e=document.querySelectorAll("a.savefrom_vk_download,div.savefrom_vk_download,span.savefrom_vk_download"),t=e.length-1;t>=0;t--)te.elIsHidden(e[t])&&e[t].parentNode.removeChild(e[t])},Y=function(){if(null!==document.querySelector('.page_block_header_inner._header_inner a.ui_crumb[href="/audio"]')){var e=document.querySelector(".page_block_header_inner._header_inner div.ui_crumb");if(e&&e.textContent)return P.a.modify(e.textContent)}var t=document.title,n=t.indexOf("|");return-1!==n&&(t=t.substr(0,n-1)),P.a.modify(t)},Z=function(e){try{var t=JSON.parse(e).payload[1];return[null,null,null,null,null,t[0],t[1],null,t[3]]}catch(e){}for(var n=function(e){return!0===e?1:parseInt(e)||0},r=function(e){return!0===e?1:parseFloat(e)||0},o=e.split("<!>"),a=o.length-1;a>=0;--a){var i=o[a];if("<!"==i.substr(0,2)){var s=i.indexOf(">"),u=i.substr(2,s-2);switch(i=i.substr(s+1),u){case"json":var l=null;try{l=JSON.parse(i)}catch(e){}o[a]=l;break;case"int":o[a]=n(i);break;case"float":o[a]=r(i);break;case"bool":o[a]=!!n(i);break;case"null":o[a]=null;break;case"pageview_candidate":o.pop();break;case"debug":o.pop()}}}return o},ee=function(e){return/<em>.*<\/em>/.test(e)&&(e=e.replace(/<\/?em>/g,"")),e},te={audioElClassList:["audio","audioRow","audioRowWall"],lastRow:null,className:"savefrom_vk_download",cache:{},lastValidRequest:null,waitUntilUnblock:function(e){var t=this,n=10;if(!t.lastValidRequest)return Promise.reject(new Error("Last valid request is empty!"));return function r(){return new Promise((function(e){setTimeout(e,15e3)})).then((function(){if(e.abort)throw new Error("Abort");return Object(x.a)(t.lastValidRequest).then((function(e){if(n--,!Z(e.body)[5]){if(n>0)return r();throw new Error("Can't request data")}}))}))}().then((function(){return new Promise((function(e){setTimeout(e,250)}))}))},needUnmask:function(e){var t=/audio_api_unavailable/;return e.some((function(e){if(t.test(e[2]))return!0}))},unmaskUrlViaUtil:function(e){return te.needUnmask(e)?Object(Q.a)([],"function(){return vk.id}").then((function(t){var n=e.map((function(e){try{return Array.isArray(e)&&e[2]?(e[2]=F(t,e[2]),e):null}catch(e){return le.debug("track decode error: ",e),null}}));return Promise.all(n).then((function(e){return e.filter((function(e){return null!==e}))}))})):Promise.resolve(e)},unmaskUrl:function(e){return te.needUnmask(e)?Object(Q.a)([e],'function(idsArr){var aFail=false;var bFail=false;var cFail=false;var unmaskUrl=function unmaskUrl(url){var _url="";if(!aFail&&window.sfUnmaskUrl){try{_url=window.sfUnmaskUrl(url)}catch(err){aFail=true}}if(!cFail&&!_url&&window.AudioPlayerHTML5){try{var res=null;var r={_isHlsUrl:function _isHlsUrl(url){res=url;return true},_initHls:function _initHls(){}};window.AudioPlayerHTML5.prototype._setAudioNodeUrl.apply(r,[null,url]);_url=res}catch(err){cFail=true}}if(!bFail&&!_url&&window.AudioPlayerFlash){try{var r={};window.AudioPlayerFlash.prototype.setUrl.apply(r,[url]);_url=r._url}catch(err){bFail=true}}if(typeof _url!=="string"){_url=""}return _url};idsArr.forEach(function(item){var url=unmaskUrl(item[2]);if(url){item[2]=url}});return idsArr}').then((function(t){return t||e})):Promise.resolve(e)},_getNewTrackListByIdsWithActionHash:function(e){for(var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=9,o=0,a={},i=this.cache,s=e.filter((function(e){var t=e.fullId;return!i[t]||(a[t]=i[t],o++,!1)})),u=[];s.length;)u.push(s.splice(0,r));var l=e.length,c=Promise.resolve();u.forEach((function(e){c=c.then((function(){var r=function(){if(n.abort)throw new Error("Abort");var r=e.filter((function(e){return e.fullId&&e.actionHash&&e.urlHash})).map((function(e){return e.fullId+"_"+e.actionHash+"_"+e.urlHash})),s={type:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},data:ue.stringify({act:"reload_audio",al:1,ids:r.join(",")}),url:"/al_audio.php",localXHR:!0};return Object(x.a)(s).then((function(e){var r=Z(e.body)[5];if(!r||!Array.isArray(r))throw new Error("Track list is not found!");return t.lastValidRequest=s,r.forEach((function(e){var t=e[1]+"_"+e[0];i[t]=e,a[t]=e,o++})),n.onProgress&&n.onProgress(o,l),new Promise((function(e){setTimeout(e,250)}))}))},s=2;return function e(){return r().catch((function(o){if("Track list is not found!"===o.message&&!n.withoutUnblock){if(t.lastValidRequest)return t.waitUntilUnblock(n).then(r);if(s-- >0)return new Promise((function(e){return setTimeout(e,15e3)})).then((function(){return e()}))}throw o}))}().catch((function(e){"Abort"!==e.message&&le.debug("requestIds error!",e)}))}))})),c=c.then((function(){Object.keys(i).slice(1e3).forEach((function(e){delete i[e]}));var t=[];return e.forEach((function(e){var n=e.fullId,r=a[n];r&&t.push(r)})),t}));var d=function(e){if(te.isHlsLink(e)){var t=(e=e.replace("/index.m3u8",".mp3")).split("/"),n=-1!==e.indexOf("audios")?1:0;return t.splice(t.length-(2+n),1),t.join("/")}return e};return c=c.then((function(e){return te.unmaskUrlViaUtil(e)})).then((function(e){var t=Object(oe.a)(5),n=e.map((function(e){return t((function(){var t=e[2],n=d(t);return te.isHlsLink(t)?Object(x.a)({method:"HEAD",url:n}).then((function(){return e[2]=n,e}),(function(t){return le.warn("getNewTrackListByIdsWithActionHash: mp3 file not available. ",t),e})):e}))}));return Promise.all(n)}))},_getAlbumIdFromUrl:function(e){var t=this,n=[e],r=Object(h.a)(e);r.z&&n.unshift(r.z);var o=null;return n.some((function(e){if(o=t._getAlbumId(e))return!0})),o},_getAlbumId:function(e){if(/[?&]q=/.test(e))return null;var t={url:"/al_audio.php",data:{}},n=/audio_playlist(-?\d+)_(-?\d+)(?:\/(\w+))?/.exec(e);if(n&&(t.data.access_hash=n[3]||"",t.data.act="load_section",t.data.al=1,t.data.claim=0,t.data.owner_id=n[1],t.data.playlist_id=n[2],t.data.type="playlist",t.data.offset=0),!t.data.act){var r=/audios(-?\d+)/.exec(e);if(r){var o=/[?&]section=(\w+)/.exec(e),a=o&&o[1];if(a&&-1===["playlists","all"].indexOf(a))return null;t.data.access_hash="",t.data.act="load_section",t.data.al=1,t.data.claim=0,t.data.owner_id=r[1],t.data.playlist_id=-1,t.data.type="playlist",t.data.offset=0}}return t.data.act?t:null},getNewNodeTrackInfo:(T=Object(i.a)(u.a.mark((function e(t){var n,r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.readNewDataAudio(t.dataset.audio),(r=this.getNewTrackInfo(n))&&r.fullId){e.next=4;break}throw new Error("Track info is not found");case 4:if(!r.url){e.next=6;break}return e.abrupt("return",te.unmaskUrlViaUtil([[null,null,r.url]]).then((function(e){return r.url=e[0][2],r})));case 6:return e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return T.apply(this,arguments)}),_getAlbumTrackViaApi:function(e,t){if(!e.url)throw le.debug("Page is not exists!",e),new Error("Page is not exists!");var n=JSON.parse(JSON.stringify(e.data)),r=function(){return t.abort?Promise.reject(new Error("Abort")):Object(x.a)({type:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},url:e.url,data:n,timeout:6e4,localXHR:!0}).then((function(e){var t=Z(e.body)[5];if(!t)throw new Error("Album data is empty!");return new Promise((function(e){setTimeout(e,250)})).then((function(){return t}))}))};return r().then((function(e){var t=20;return e.hasMore?function o(a){return!a||t<0?e:(t--,n.offset=a,r().then((function(t){return t.list.length?(e.list.push.apply(e.list,t.list),t.hasMore?o(t.nextOffset):e):e}),(function(t){return"Abort"!==t.message&&le.debug("getOffset error!",t),e})))}(e.nextOffset):e}))},_getAllTrackViaDom:function(e,t){var n=this;t=t||{};var r=[];return[].slice.call(e.querySelectorAll(".audio_row")).forEach((function(e){if((!t.fromPage||!n.elIsHidden(e))&&(t.grabReply||!de.isReply(e))){var o=null;try{o=JSON.parse(e.dataset.audio)}catch(e){}o&&r.push(o)}})),{list:r}},_getNewAudioLinks:function(e,t){var n=this;t=t||{};var r=(e=e||document)===document,o=de.getPopup("","audio",(function(){t.abort=!0}));o.onPrepare(l.a.i18n.getMessage("download")+" ...");var a=function(){return Promise.resolve().then((function(){return n._getAllTrackViaDom(e,{fromPage:r,grabReply:!1})}))};t.onProgress=function(e,t){o.onProgress(e,t)};var i=Promise.resolve();return i=(i=(i=(i=r?i.then((function(){return Promise.resolve().then((function(){var e=n._getAlbumIdFromUrl(location.href);if(!e)throw new Error("Album is not found");return n._getAlbumTrackViaApi(e,t)}))})).catch((function(e){throw"Album is not found"!==e.message&&le.debug("findAlbumLinks error!",e),e})).catch((function(){return a()})):i.then(a)).then((function(e){var t=e.list;if(!t.length)throw new Error("Audio is not found");return o.onProgress(0,t.length),e}))).then((function(e){var r=[],o="";"string"==typeof e.title&&(o=P.a.modify(e.title));var a=[];return e.list.forEach((function(e){var t=e[1]+"_"+e[0],n=te.getTrackActionHash(e),o=te.getTrackUrlHash(e);-1===a.indexOf(t)&&(a.push(t),r.push({fullId:t,actionHash:n,urlHash:o}))})),n._getNewTrackListByIdsWithActionHash(r,t).then((function(e){var t={},r=[];return e.forEach((function(e){var o=n.getNewTrackInfo(e);if(o&&o.url){var a=n.getNewAudioFilename(o),i=n.getNewAudioFullTitle(o);t[o.fullId]=o.url,r.push({url:o.url,title:i,filename:a})}})),{linkList:t,trackList:r,title:o}}))}))).then((function(e){return o.onReady(),e}),(function(e){throw o.onReady(),e}))},tooltip:{tooltip:void 0,updatePos:function(e,t){var r=n.getPosition(e),o=n.getSize(this.tooltip);this.tooltip.style.top=r.top+t.top-o.height+"px";var a=r.left+parseInt(t.width/2)-parseInt(o.width/2),i=document.body.clientWidth+document.body.scrollLeft;i<a+o.width&&(a=i-o.width),this.tooltip.style.left=a+"px"},show:function(e,t){var n=this;return void 0!==this.tooltip?this.hide():(this.tooltip=S.a.create("div",{class:"sf-tooltip",style:Object.assign({position:"absolute",display:"none",zIndex:9999,opacity:0,transition:"opacity 0.2s",whiteSpace:"nowrap"},t.style),on:["mouseenter",function(e){n.hide()}]}),document.body.appendChild(this.tooltip)),this.tooltip.style.display="block",setTimeout((function(){n.updatePos(e,t),n.tooltip.style.opacity=1}),0),this.tooltip},hide:function(){this.tooltip&&(this.tooltip.style.opacity=0,this.tooltip.style.display="none")}},rmBitrate:function(){void 0===te.rmBitrate.style&&document.body.appendChild(te.rmBitrate.style=S.a.create("style",{text:".sf-bitrate-value {display: none;}"}));for(var e,t=document.querySelectorAll(".sf-bitrate-value"),n=0;e=t[n];n++)e.parentNode.removeChild(e)},insertNewBitrate:function(e,t){if(e&&t&&t.classList.contains("audio_row__info")){var n=t.querySelector(".audio_row__duration");if(n&&(void 0!==te.rmBitrate.style&&(te.rmBitrate.style.parentNode.removeChild(te.rmBitrate.style),te.rmBitrate.style=void 0),!n.querySelector(".sf-bitrate-value"))){var r=S.a.create("span",{text:" "+e,class:"sf-bitrate-value",style:{position:"absolute",textAlign:"right",right:0,opacity:"0.8",top:"14px",fontSize:"11px",whiteSpace:"nowrap"}});n.appendChild(r)}}},onDlBtnLeave:function(){te.tooltip.hide()},onDlBtnOver:function(){var e=te,t=e.tooltip,n=this,r=n.dataset.fullId,o=n.parentNode&&n.parentNode.parentNode,a=-6;n.dataset.bitrateOffsetTop&&(a=parseInt(n.dataset.bitrateOffsetTop));var i={top:a,width:24,style:{backgroundColor:"#fff",border:"1px solid #ccc",color:"rgb(48, 48, 48)"}},s=t.show(n,i);s.dataset.fullId=r;var u=function(){var t=n.dataset.bitrate,r=n.dataset.size,a="";e.isHlsLink(n.href)?a=l.a.i18n.getMessage("download"):r?t?(e.insertNewBitrate(t,o),a=r+" ~ "+t):a=r:a=l.a.i18n.getMessage("getFileSizeFailTitle"),s.style.padding="2px 5px 3px",s.textContent=a};n.dataset.size||e.isHlsLink(n.href)?u():(s.style.padding="2px 2px 0 2px",s.textContent="",s.appendChild(S.a.create("img",{src:"/images/upload.gif",height:8,width:32,style:{marginTop:"2px",marginBottom:"1px"}})),n.dataset.preloadOver||(n.dataset.preloadOver=1,e._preloadNewTrackUrl(n).then((function(a){if(n.dataset.preloadOver=2,n.href=a,!e.isHlsLink(a))return e._onOverInsertBitrate(n,o).then((function(){s.dataset.fullId===r&&(u(),t.updatePos(n,i))}));u(),t.updatePos(n,i)})).catch((function(e){le.error("_preloadNewTrackUrl error",e),n.dataset.preloadOver="",s.dataset.fullId===r&&(u(),t.updatePos(n,i))}))))},preloadIdPromiseMap:{},_preloadNewTrackUrl:function(e){var t=this,n=t.preloadIdPromiseMap,r=e.dataset.fullId,o=e.dataset.actionHash,a=e.dataset.urlHash,i=n[r];return i||(i=n[r]=t._getNewTrackListByIdsWithActionHash([{fullId:r,actionHash:o,urlHash:a}],{withoutUnblock:!0}).then((function(e){delete n[r];var o=null;e.some((function(e){if(e[1]+"_"+e[0]===r)return o=e,!0}));var a=o&&t.getNewTrackInfo(o);if(!a||!a.url)throw new Error("Track is not found");return a.url}),(function(e){throw delete n[r],e})).then((function(e){return te.unmaskUrl([e])})).then((function(e){return e[0]}))),i},isHlsLink:function(e){return/\.m3u8(\?|$)/.test(e)},onNewDlBtnClick:function(e){te.isHlsLink(this.href)?(e.preventDefault(),Object(U.a)(Object(z.e)(W.a,{sources:[{url:this.href,format:"hls"}],filename:this.download,format:"mp3",convertType:"hlsToMp3"}),"sf-muxer-parent")):n.downloadOnClick(e);for(var t,r=document.querySelectorAll("._audio_row_"+this.dataset.fullId),o=0;t=r[o];o++)t.style.backgroundColor="#f4f7fc"},_onNewDlBtnClickWrapper:function(e){var t=te,n=this;e.stopPropagation(),(n.dataset.preloadOver>1||n.dataset.preloadBitrate>1)&&(n.dataset.preloadDl=2),n.dataset.preloadDl?n.dataset.preloadDl>1?te.onNewDlBtnClick.call(n,e):e.preventDefault():(e.preventDefault(),n.dataset.preloadDl=1,t._preloadNewTrackUrl(n).then((function(t){n.dataset.preloadDl=2,n.href=t,te.onNewDlBtnClick.call(n,e)}),(function(e){le.error("_preloadNewTrackUrl error",e),n.dataset.preloadDl=""})))},getNewDlBtn:function(e,t){var n={href:e.url||"#sf-preload",class:[te.className,"sf-audio-btn"],download:P.a.modify(t)||"",data:{duration:e.duration||"",fullId:e.fullId,actionHash:e.actionHash,urlHash:e.urlHash},style:{width:"16px",height:"16px"},on:[["mouseenter",this.onDlBtnOver],["mouseleave",this.onDlBtnLeave],["click",this._onNewDlBtnClickWrapper],["mousedown",function(e){e.stopPropagation()}]]};return(l.a.isGM||l.a.isSafari)&&(n.title=l.a.i18n.getMessage("downloadTitle")),S.a.create("a",n)},preloadSizePromiseMap:{},_onOverInsertBitrate:function(e,t){var r=this,o=r.preloadSizePromiseMap,a=e.dataset.fullId,i=o[a];return i||(i=o[a]=function(e){var t=V[e];if(t){var n=H.indexOf(e);-1!==n&&(H.splice(n,1),H.unshift(e))}else if(t=V[e]=Object(L.a)({action:"getFileSize",url:e}).then((function(t){return t&&!t.error||delete V[e],t})).catch((function(t){throw delete V[e],t})),H.unshift(e),H.length>100){var r=H.pop();delete V[r]}return t}(e.href).then((function(i){if(delete o[a],!i)throw new Error("Response is empty");if(!i.fileSize)throw delete r.cache[a],new Error("File size is empty");var s=n.sizeHuman(i.fileSize,2),u="";e.dataset.duration&&(u=Math.floor(i.fileSize/e.dataset.duration/125)+" "+l.a.i18n.getMessage("kbps")),e.dataset.bitrate=u,e.dataset.size=s,te.insertNewBitrate(u,t)}),(function(e){throw delete o[a],e}))),i},getNewAudioFullTitle:function(e){var t=[];return e.title&&t.push(e.title),e.performer&&(t.length&&t.unshift(" - "),t.unshift(e.performer)),t.join("")},getNewAudioFilename:function(e){var t=this.getNewAudioFullTitle(e);return t&&(t+=".mp3"),t},handleNewCurrentAudioRow:function(e,t,r){if(!e.querySelector("."+te.className)){var o=this.getNewAudioFilename(t),a=this.getNewDlBtn(t,o),i="#6C8CAC";1===r&&(i="#C4D1DE"),a.classList.remove("sf-audio-btn"),S.a.create(a,{style:{background:"url("+n.svg.getSrc("download",i)+") center no-repeat",backgroundSize:"12px",width:"12px",height:"12px",padding:0,margin:0,cssFloat:"left",marginRight:"3px",marginTop:"6px",marginBottom:"-2px"}});var s=null;if(O.a.onRemoveEvent(a,(function(){O.a.one(e,"mouseenter",X.mutationMode.wrapNewAudioOnMouseOver),s&&s.stop()})),2===r){var u=Object(w.a)(e,".audio_page_player");u&&(s=new I.a({target:u,attrs:[{name:"data-full-id",callback:function(){a.parentNode&&a.parentNode.removeChild(a),s&&s.stop()}}]})).trigger()}1===r&&(a.dataset.bitrateOffsetTop=1),e.insertBefore(a,e.firstChild)}},handleNewAudioRow:function(e,t,n){if(!e.querySelector("."+te.className)){var o=this,a=this.getNewAudioFilename(n),i=this.getNewDlBtn(n,a),s=t.parentNode;S.a.create(i,{class:["audio_row__action"],style:{width:"24px",height:"24px",cssFloat:"left"},on:[["mouseover",function(e){if(ce){if(!e.altKey&&!e.ctrlKey)return e.preventDefault(),void Object(ae.b)(i,{defaultWidth:400,defaultHeight:60},{});Object(ae.a)(i,{defaultWidth:400,defaultHeight:60})}}]]});var u=t.firstChild;u?t.insertBefore(i,u):t.appendChild(i),1===r.vkShowBitrate&&(i.dataset.preloadBitrate||(i.dataset.preloadBitrate=1,o._preloadNewTrackUrl(i).then((function(e){return i.dataset.preloadBitrate=2,i.href=e,o._onOverInsertBitrate(i,s)})).catch((function(e){le.error("_preloadNewTrackUrl error",e)}))))}},addNewDlTrackBtn:function(e){var t=this,n=function(){a.disconnect()},r=null,o=function(o){r||(r=t.getNewNodeTrackInfo(e)),r.then((function(n){return function(n,r){t.handleNewAudioRow(e,n,r)}(o,n)})).catch((function(e){le.error("Fetch track info error: "+e.message),n()}))},a=new(Object(C.a)())((function(e){if(s){for(var t=null,r=null,a=0;t=e.shift();)if("childList"===t.type&&t.addedNodes.length&&t.target.classList.contains("audio_row__info"))for(a=0,t.addedNodes;r=t.addedNodes[a];a++)if(r.classList.contains("audio_row__actions"))return void o(r)}else n()}));a.observe(e,{childList:!0,subtree:!0});var i=e.querySelector(".audio_row__actions");i&&(o(i),i=null)},getNewTrackInfo:function(e){if(!e)return null;var t={};return"string"==typeof e[2]&&(t.url=e[2]),t.title=e[3],t.title&&(t.title=P.a.decodeSpecialChars(ee(t.title))),t.performer=e[4],t.performer&&(t.performer=P.a.decodeSpecialChars(ee(t.performer))),t.duration=parseInt(e[5]),t.actionHash=te.getTrackActionHash(e),t.urlHash=te.getTrackUrlHash(e),e[1]&&e[0]&&(t.fullId=e[1]+"_"+e[0]),t.id=e[0],t.ownerId=e[1],t},getTrackActionHash:function(e){return(e[13]||"").split("/")[2]||""},getTrackUrlHash:function(e){return(e[13]||"").split("/")[5]||""},readNewDataAudio:function(e){try{return JSON.parse(e)}catch(e){return null}},addNewDlCurrentTrackBtn:function(e,t){var n=this;return Object(Q.a)((function(){var e=null;if("undefined"!=typeof ap&&ap._currentAudio&&(e=ap._currentAudio),!e&&"undefined"!=typeof cur&&cur.audioPage&&cur.audioPage._readyAudio&&(e=cur.audioPage._readyAudio),!e)try{e=JSON.parse(localStorage.audio_v9_track)}catch(e){}return e})).then((function(r){if(!r){var o=document.querySelector(".audio_page_player[data-audio]");r=o&&_this.readNewDataAudio(o.dataset.audio)}var a=r&&n.getNewTrackInfo(r);a&&(a.url||a.fullId)&&n.handleNewCurrentAudioRow(e,a,t)}))},onNewMouseOver:function(e){var t=te;if(this&&!this.querySelector("."+te.className)){var n=null;this.classList.contains("top_audio_player_title")&&(n=1),this.classList.contains("audio_page_player_title_performer")&&(n=2),n?t.addNewDlCurrentTrackBtn(this,n):t.addNewDlTrackBtn(this)}},addCustomStyle:function(){if(1!==this.addCustomStyle.hasStyle){this.addCustomStyle.hasStyle=1;var e=document.querySelector("#savefrom-styles.sf-audio");e&&e.parentNode.removeChild(e),n.addStyleRules(".savefrom_vk_download.sf-audio-btn",{background:"url("+n.svg.getSrc("download","#5f7fa2")+") center no-repeat !important",opacity:"0.4"},"sf-audio")}},hideLinks:function(){if(this.addCustomStyle.hasStyle){this.addCustomStyle.hasStyle=0;var e=document.querySelector("#savefrom-styles.sf-audio");e&&e.parentNode.removeChild(e),n.addStyleRules(".savefrom_vk_download",{display:"none"},"sf-audio")}te.tooltip.tooltip&&(te.tooltip.tooltip.parentNode.removeChild(te.tooltip.tooltip),te.tooltip.tooltip=void 0),te.cache={}},elIsHidden:function(e){return null===e.offsetParent},downloadMP3Files:function(){var e=de.getLayer()||document;te._getNewAudioLinks(e).then((function(e){e.linkList;var t=e.trackList,r=e.title||Y(),o=t.map((function(e){return te.isHlsLink(e.url)?{filename:e.filename,sources:[{url:e.url,format:"hls"}],format:"hls",useConverter:!0}:e}));if(0===o.length)return alert(l.a.i18n.getMessage("vkMp3LinksNotFound"));n.downloadList.showBeforeDownloadPopup(o,{type:"audio",folderName:r})}),(function(e){"Abort"!==e.message&&(le.debug("_getNewAudioLinks error!",e),alert(l.a.i18n.getMessage("vkMp3LinksNotFound")))}))},showListOfAudioFiles:function(e){var t=de.getLayer()||document;te._getNewAudioLinks(t).then((function(t){var r=t.linkList,o=t.trackList,a=t.title||Y(),i=null;if(e){if(0!==(i=o).length)return n.playlist.popupPlaylist(i,a,!0)}else{for(var s in i=[],r)i.push({url:r[s]});if(0!==i.length)return n.playlist.popupFilelist(i)}alert(l.a.i18n.getMessage("vkMp3LinksNotFound"))}),(function(e){"Abort"!==e.message&&(le.debug("_getNewAudioLinks error!",e),alert(l.a.i18n.getMessage("vkMp3LinksNotFound")))}))},requestReloadAudio:function(e,t,n){var r={act:"reload_audio",ids:"".concat(e,"_").concat(t,"_").concat(n)};return Object(x.a)({type:"POST",url:"/audio",json:!0,data:r}).then((function(e){var t=e.body.data;return te.getNewTrackInfo(t[0][0])}))}},ne={panelId:"savefrom__vk_video_links",videoAttr:"data-savefrom-video",hiddenAttr:"data-savefrom-hidden",btnBoxId:"sf-iframe-dl-btn",btnBox:null,style:{fontSize:"10pt",margin:"15px 0",padding:"0"},getLinksFormUrl:function(e){if(e){if("//"===e.substr(0,2)&&(e="http:"+e),r.showUmmyItem&&this.isRutubeLink(e))return ne.getRutubeLinks(e);if(this.isPladformLink(e))return ne.getPladformLinks(e);var t,o=n.embedDownloader.hostings;for(var a in o){for(var i,s=o[a],u=0;i=s.re[u];u++){var l=e.match(i);if(l){t={hosting:a,action:s.action,extVideoId:l[1]};break}}if(t)break}if(t)return{request:t}}},getLinksFromFlashVars:function(e){var t=Object(h.a)(e,{params:!0});return ne.getLinksFromHtml5MetaData(t)},getLinksFromHtml5MetaData:function(e){if(e){var t=e.md_title;if(void 0!==t){var n=Object.keys(e).some((function(e){return e.match(/cache([0-9]+)/)}))?/cache([0-9]+)/:/url([0-9]+)/,r={},o=!1;for(var a in e){var i=null;if("extra_data"!==a||"52"!==e.extra){if(null!==(i=a.match(n))){var s=e[a],u=s.indexOf("?");-1!==u&&(s=s.substr(0,u)),o=!0,r[i[1]]=s}}else r[i=e.hd?"HD":"SD"]=e[a],o=!0}if(o)return{title:t,links:r}}}},getRutubeLinks:function(e){if(/rutube[^\/]+\/(?:play|video)\/embed\/(\d+)/.test(e)||/video\.rutube\./.test(e))return{isUmmy:!0,links:n.popupMenu.prepareLinks.rutube(e)}},isRutubeLink:function(e){return/\/\/.*rutube\..*/.test(e)},getPladformLinks:function(e){if(e){var t=Object(h.a)(e);return{request:{action:"getPladformVideo",extVideoId:{playerId:t.pl,videoId:t.videoid}}}}},isPladformLink:function(e){return/\/\/.*pladform\..*/.test(e)},getLinksVideoEl:function(e,t){var n=t.querySelector(".vv_summary");if(!n)return null;n=n.textContent;for(var r,o,a={},i=e.querySelectorAll("source"),s=0;o=i[s];s++){var u=o.src||"",l=u.indexOf("?");-1!==l&&(u=u.substr(0,l));var c=u.match(/\.(\d+)\.[^\/]+$/);null!==c&&(a[c[1]]=u,r=!0)}return r?{title:n,links:a}:void 0},getPlayerNode:function(e){var t=null;return["iframe.video_yt_player","#html5_player","#flash_video_obj","#playerObj","#player",".video_box_wrap > #video_player"].some((function(n){if(t=e.querySelector(n))return!0})),t},getLinksFromMv:function(e,t,n){return Object(Q.a)([t,e],(function(e,t){var r=window.mvcur;if(r&&r.player&&r.player.vars){var o=r.player.vars;return o.vid!==e||o.oid!==t?n():{vars:r.player.vars}}})).then((function(e){return e?ne.getLinksFromHtml5MetaData(e.vars):null}))},getLinksFromFrame:function(e){var t=document.body.innerHTML,n=Object(h.a)(location.href),r=parseInt(n.oid),o=parseInt(n.id);if(r&&o){var a=null;if(Object(g.a)(t,[/"vid":/,/"oid":/,/"md_title":/]).some((function(e){return a=e,!0})),a&&a.vid===o&&a.oid===r)return e(null,{request:{hosting:"vk",action:"getVkLinksFromJsonMsg",json:a}});var i=document.body,s=ne.getPlayerNode(i);if(s)return ne.getLinksFromPlayer(i,s,(function(t){t&&e(null,t)}))}return e("ERROR")},getLinksFromPlayer:function(e,t,r){if(t){var o,a;if("OBJECT"===t.tagName)(a=t.querySelector('param[name="flashvars"]'))&&(a=a.getAttribute("value"),o=ne.getLinksFromFlashVars(a));else if("IFRAME"===t.tagName){var i=t.getAttribute("src");o||(o=ne.getLinksFormUrl(i))}else if("EMBED"===t.tagName){var s=t.getAttribute("src");o||(a=t.getAttribute("flashvars"))&&(o=ne.getLinksFromFlashVars(a)),o||(o=ne.getLinksFormUrl(s))}if(o)return r(o,e);if("DIV"===t.tagName&&"video_player"===t.id){var u=t.parentNode.id,l=u&&u.match(/video_box_wrap(-?\d+)_(-?\d+)/);if(l)return l.shift(),l=l.map((function(e){return parseInt(e)})),Object(Q.a)(l,(function(e,t){var n=window.mvcur;if(!n)return r();var o="video"+e+"_"+t;return n.listId&&(o+="?list="+n.listId),{path:o}})).then((function(t){if(t)return r({request:{hosting:"vk",action:"getVKLinks",extVideoId:t.path,oidVid:l}},e)}))}if("html5_player"===t.id)return Object(Q.a)((function(){return window.html5video&&window.html5video.vars?window.html5video.vars:r()})).then((function(t){var n=ne.getLinksFromHtml5MetaData(t);if(n)return r(n,e)}));if("A"===t.tagName){var c=t.href,d=Object(h.a)(c);if(d.to)return o=n.embedDownloader.checkUrl(d.to),r(o?{request:o}:null,e)}return r(null,e)}},preparePladformLinks:function(e){e&&"getRutubeLinks"===e.action&&(e.links=null);var t=e&&e.links,n="noname",r={};if(t)for(var o,a=0;o=t[a];a++)n=o.title,r[o.quality]&&(o.quality=0),r[o.quality.toUpperCase()]=o.url;return{title:n,links:r}},prepareLinks:function(e){var t=e.title,n=[];for(var r in e.links){var o=e.links[r],a=o.match(/[\w]+\.(mp4|flv)(?:\?|$)/i),i=(a=a?a[1]:"flv").toUpperCase();n.push({href:o,quality:r,title:t,ext:a,format:i,forceDownload:!0})}return n},getVideoLinksAsAjax:function(e){var t=/video(-?\d+_-?\d+)/.exec(e);t=t&&t[1];var n=Object(h.a)(e).list;return de._getModuleName().then((function(e){return new Promise((function(r){ie.getLinkAsAjax([t,n],(function(e,t){r({hosting:t,response:e})}),e)}))}))},prepareVideoLinks:function(e){return Object(i.a)(u.a.mark((function t(){var i,s,l,c,d,f,p,h,m,v,g,b,y,w,k,_,O,S,A,P,M,j,N,C,I,F;return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=[],!e||!e.oidVid){t.next=7;break}return s=Object(a.a)(e.oidVid,2),l=s[0],c=s[1],t.next=5,ne.getLinksFromMv(l,c);case 5:(d=t.sent)&&(f=i).push.apply(f,Object(o.a)(ne.prepareLinks(d)));case 7:return t.next=9,Object(L.a)(e);case 9:if((p=t.sent)&&("getPladformVideo"===e.action?r.showUmmyItem&&"getRutubeLinks"===p.action?(h=i).push.apply(h,Object(o.a)(n.popupMenu.prepareLinks.rutube(p.links))):(m=i).push.apply(m,Object(o.a)(ne.prepareLinks(ne.preparePladformLinks(p)))):p.links&&(v=n.embedDownloader.reMapHosting(p.action))&&(g=i).push.apply(g,Object(o.a)(n.popupMenu.prepareLinks[v](p.links,p.title)))),i.length||"getVKLinks"!==e.action){t.next=18;break}return t.next=14,ne.getVideoLinksAsAjax(e.extVideoId);case 14:b=t.sent,y=b.hosting,(w=b.response)&&w.links&&(w.isUmmy?(k=i).push.apply(k,Object(o.a)(w.links)):(_=i).push.apply(_,Object(o.a)(n.popupMenu.prepareLinks[y](w.links,w.title))));case 18:if(!(i.filter((function(e){return-1!==e.href.indexOf("mycdn.me/")})).length||i.length<=2)){t.next=39;break}if(!e.extVideoId){t.next=39;break}return S={},(A=document.querySelector('a[href*="'+e.extVideoId+'"]'))&&A.dataset.length&&((P=A.closest('[id*="post"]'))&&(S.post_id=P.dataset.postId),S.list=A.dataset.list,S.paylist_id="wall_"+A.dataset.video.split("_")[0]),S.video=e.extVideoId.split("?")[0].replace("video",""),(M=location.href.match(/pl_(wall_.\d+)/))&&M[1]&&(S.playlist_id=M[1]),(j=document.querySelector('a[data-video="'.concat(S.video,'"]')))&&j.dataset.list&&(S.list=j.dataset.list),t.next=31,Object(x.a)({type:"POST",url:"https://vk.com/al_video.php?act=show",data:se({act:"show",al:1,autoplay:1,module:"groups"},S)});case 31:return N=t.sent,t.next=34,J(p.title,N.body);case 34:C=t.sent,I=C.hls,F=C.mp4,(O=i).push.apply(O,Object(o.a)(F).concat(Object(o.a)(I))),i=R(i,"href");case 39:return t.next=41,$(R(i,"quality","itag"),(function(e){return 22==e.itag}));case 41:return i=(i=t.sent).map((function(e){return e.title="."===e.title?"video-"+e.quality:e.title,e})),t.abrupt("return",i);case 44:case"end":return t.stop()}}),t)})))()},newAppendButton:function(e,t){if(e){var r=t.querySelector("#mv_info"),o=r&&r.querySelector(".mv_actions_block .like_cont .like_btns");r=null;var a=function(e){return e?e.querySelector("#mv_top_controls, #VideoLayerInfo__topControls"):null},s=a(t);if(s||(s=a(t.closest("#mv_container"))),o&&te.elIsHidden(o)&&(o=null),o||s){for(var c,d=!(o||!s),f=t.querySelectorAll(".savefrom_vk_download"),p=0;c=f[p];p++)c.parentNode.removeChild(c);c=null,f=null;var h=S.a.create("div",{class:["savefrom_vk_download","sf-under-video"],style:{cursor:"pointer"},on:[["click",function(){var r=Object(i.a)(u.a.mark((function r(o){var a,i;return u.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(o.stopPropagation(),O.a.onRemoveEvent(this,X.hideMenu),!X.contextMenu||!X.contextMenu.isShow){r.next=5;break}return X.hideMenu(),r.abrupt("return");case 5:if(a=X.contextMenu=n.popupMenu.quickInsert(this,l.a.i18n.getMessage("download")+"...","sf-single-video-menu",{parent:t}),!e.isUmmy){r.next=9;break}return a.update(e.links),r.abrupt("return");case 9:return r.next=11,ne.prepareVideoLinks(e.request);case 11:return i=(i=r.sent).map((function(e){return"MP4"===e.format&&(e.forceDownload=!0),e})),r.abrupt("return",a.update(i));case 14:case"end":return r.stop()}}),r,this)})));return function(e){return r.apply(this,arguments)}}()],["mousedown",function(e){e.stopPropagation()}],["keydown",function(e){e.stopPropagation()}]]});if(o){S.a.create(h,{class:["like_btn"],append:[S.a.create("div",{class:["like_button_icon"],append:[S.a.create("img",{src:n.svg.getSrc("download","#828a99"),width:16,height:16,style:{margin:"4px"}})]}),S.a.create("div",{class:["like_button_label"],text:l.a.i18n.getMessage("download")})]});var m=o.querySelector(".ui_actions_menu_wrap");m?m.parentNode.insertBefore(h,m):o.appendChild(h)}else if(d){S.a.create(h,{class:["mv_top_button"],style:{textAlign:"center"},append:[S.a.create("img",{class:["mv_small_close_icon"],style:{backgroundImage:"none",width:"20px",height:"20px"},src:n.svg.getSrc("download","#FFFFFF"),width:20,height:20})]});var v=s.firstChild;if(v)if(te.elIsHidden(s.lastChild)){for(;v.nextElementSibling&&!te.elIsHidden(v.nextElementSibling);)v=v.nextElementSibling;v.parentNode.insertBefore(h,v)}else s.appendChild(h);else s.appendChild(h)}}}},appendNewFrameBtn:function(e,t){var o=this;if(!t.querySelector(".savefrom_vk_download")){var a=n.frameMenu.getBtn({singleBtn:!0,btnId:o.btnBoxId,containerStyle:{top:"10px",right:"10px"},on:[["click",function(t){if(t.preventDefault(),t.stopPropagation(),X.contextMenu&&X.contextMenu.isShow)X.hideMenu();else{var i=X.contextMenu=n.frameMenu.getMenu(this,l.a.i18n.getMessage("download")+"...","sf-frame-menu",{container:a.container,onShow:function(){a.node.classList.add("sf-over")},onHide:function(){X.contextMenu=null,a.node.classList.remove("sf-over")}});if(e.request){var s=function(t){var a=l.a.i18n.getMessage("noLinksFound");if(t&&"getPladformVideo"===e.request.action)a=r.showUmmyItem&&"getRutubeLinks"===t.action?n.popupMenu.prepareLinks.rutube(t.links):o.prepareLinks(o.preparePladformLinks(t));else if(t&&t.links){var s=n.embedDownloader.reMapHosting(t.action);s&&(a=n.popupMenu.prepareLinks[s](t.links,t.title))}i.update(a)};try{l.a.sendMessage(e.request,s)}catch(t){s()}}else i.update(o.prepareLinks(e));!1}}],["mousedown",function(e){e.stopPropagation(),2===e.button&&(X.hideMenu(),a.container.parentNode&&a.container.parentNode.removeChild(a.container))}]]});a.container=S.a.create("div",{class:"sf-btn-ctr",append:a.node}),a.node.appendChild(S.a.create("style",{text:Object(b.a)([{selector:["body:hover .sf-btn-ctr #"+o.btnBoxId,"body:hover .sf-btn-ctr .sf-frame-menu"],style:{display:"block"}}])})),document.body.appendChild(a.container)}},addFrameBtn:function(){var e=document.getElementById("page_wrap");e&&ne.getLinksFromFrame((function(t,n){t||ne.appendNewFrameBtn(n,e)}))}},ie={linkDataAttr:"savefromHasBtn",getLinkAsAjaxRequest:function(e,t){t=t||0;var n=Object.assign({},e),r=function(){if(t<1)return ie.getLinkAsAjaxRequest(e,++t);e.error&&e.error()},o=n.data;0===t?o.act="show_inline":1===t&&(o.act="show"),Object(_.a)(n,(function(t,n,o){return t||!o||-1!==o.indexOf('href="/join"')?r():void e.success(o)}))},getVideoDataFromLink:function(e){var t=e.getAttribute("onclick"),n=/showVideo\(['"]{1}([^'"]+)['"]{1},.?['"]{1}([^'"]+)['"]{1},.*\)/.exec(t);return n&&n.shift(),n},getLinkAsAjax:function(e,t,o){ie.getLinkAsAjaxRequest({localXHR:1,type:"POST",url:"/al_video.php",data:{list:e[1],video:e[0],act:"show_inline",module:o,al:1},success:function(e){if(!e)return t();var o=e.match(/<iframe[^>]+src=['"]{1}([^'">]+)['"]{1}[^>]+>/i);if(o||(o=e.match(/var\s+opts\s+=\s+({[^}]*})/im))&&(o=o[1].match(/url:\s+['"]{1}([^'"]+)['"]{1}/i))&&0!==o[1].indexOf("//")&&0!==o[1].indexOf("http")&&(o=null),o){var a=o[1];if(r.showUmmyItem&&ne.isRutubeLink(a))return t(ne.getRutubeLinks(a));if(0===a.indexOf("//")&&(a="http:"+a),0!==a.indexOf("http"))return t();var i=n.embedDownloader.checkUrl(a);if(!i)return t();var s={action:i.action,extVideoId:i.extVideoId};l.a.sendMessage(s,(function(e){var r=i.hosting;return e.action!==s.action&&(r=n.embedDownloader.reMapHosting(e.action)),t(e,r)}))}else Object(L.a)({action:"getVkLinksFromData",data:e}).then((function(e){return t(e,"vk")})).catch((function(){return t({},"vk")}))},error:function(){t()}})},addDownloadBtn:function(e){var t=e.href,r={display:"inline-block",width:"16px",height:"16px",marginLeft:"5px",backgroundImage:"url("+n.svg.getSrc("download","#78A2CC")+")",backgroundRepeat:"no-repeat",marginBottom:"-4px"},o=S.a.create("a",{href:"http://savefrom.net/?url="+encodeURIComponent(t),style:r,on:["click",function(e){if(e.preventDefault(),O.a.onRemoveEvent(a,X.hideMenu),X.contextMenu&&X.contextMenu.isShow)X.hideMenu();else{var t=document.querySelector("#wk_box");t&&t.contains(this)||(t=null);var r={parent:t},i=this.getAttribute(n.embedDownloader.dataAttr),s=n.embedDownloader.checkUrl(i);if(s){var u={action:s.action,extVideoId:s.extVideoId},c=X.contextMenu=n.popupMenu.quickInsert(o,l.a.i18n.getMessage("download")+" ...","sf-popupMenu",r);ne.prepareVideoLinks(u).then((function(e){e.map((function(e){return"MP4"===e.format&&(e.forceDownload=!0),e})),c.update(e)}))}else X.contextMenu=n.popupMenu.quickInsert(o,l.a.i18n.getMessage("noLinksFound"),"sf-popupMenu",r)}}]});o.setAttribute(n.embedDownloader.dataAttr,t);var a=S.a.create("span",{class:"sf-video-feed-container",on:["click",function(e){e.stopPropagation()}],append:[o]}),i=e.querySelector(".post_video_title");i?i.appendChild(a):e.appendChild(a)},onLinkHover:function(){if("A"===this.tagName){var e=this.href||"";0===this.id.indexOf("post_media_lnk")&&-1!==e.indexOf("/video")&&(X.contextMenu&&X.contextMenu.isShow&&X.hideMenu(),this.dataset[ie.linkDataAttr]||(this.dataset[ie.linkDataAttr]=1,ie.addDownloadBtn(this)))}},off:function(){for(var e,t=document.querySelectorAll(".sf-video-feed-container"),n=0;e=t[n];n++)e.parentNode.removeChild(e);var r=Object(v.a)(ie.linkDataAttr),o=document.querySelectorAll("*["+r+"]");for(n=0;e=o[n];n++)e.removeAttribute(r)}},de={photoCache:{},getAlbumId:function(e){if(!/(\?|&|#)act=edit/i.test(e)){var t=[];t.push(e);var n=Object(h.a)(e);n.w&&t.push(n.w),n.z&&t.push.apply(t,n.z.split("/")),/#/.test(e)&&(t.push(e.substr(e.indexOf("#")+1)),t.push(decodeURIComponent(e.substr(e.indexOf("#")+1)))),t.reverse();var r=null,o=null;return t.some((function(e){if(o=e.match(/(?:\/|#|=|^)(albums?|tag|photos|feed(?:\d+)?_|wall)(-?\d+)(?:_(\d+))?/i))return o[3]?r=/^(feed|wall)/.test(o[1])?o[1]+o[2]+"_"+o[3]:"album"+o[2]+"_"+o[3]:("albums"==o[1]&&(o[1]="photos"),r=o[1]+o[2]),!0})),r}},getModuleName:function(e){var t=S.a.create("script",{text:"("+'function(){if(window.cur&&window.cur.module&&typeof window.cur.module==="string"){document.body.dataset["{dataArg}"]=window.cur.module}}'.replace("{dataArg}","sfModule")+")();"});document.body.appendChild(t),setTimeout((function(){t.parentNode.removeChild(t),e(document.body.dataset.sfModule)}),0)},isReply:function(e){return Object(y.a)(e,".replies "+e.tagName)||Object(y.a)(e,".wl_replies "+e.tagName)},getWallPostContent:function(){var e=location.href.match(/wall(-?\d+_\d+)/);if(e=e&&e[1])return document.getElementById("post"+e)||document.getElementById("wpt"+e)},getPopup:function(e,t,r){var o,a=n.playlist.getInfoPopupTemplate();S.a.create(a.textContainer,{append:[S.a.create("p",{text:e,style:{color:"#0D0D0D",fontSize:"20px",marginBottom:"11px",marginTop:"13px"}}),o=S.a.create("p",{text:"",style:{color:"#868686",fontSize:"14px",lineHeight:"24px"}})]});var i=n.popupDiv(a.body,"sf_progress_popup",void 0,void 0,r),s=function e(n){e.state!==n&&(e.state=n,a.buttonContainer.style.display="none",o.style.display="none",l.a.sendMessage({action:"getWarningIcon",type:t,color:"#77D1FA"},(function(e){a.icon.style.backgroundImage="url("+e+")"})),"progress"===n&&(o.style.display="block"),"error"===n&&(l.a.sendMessage({action:"getWarningIcon",type:t,color:"#AAAAAA"},(function(e){a.icon.style.backgroundImage="url("+e+")"})),o.style.display="block"))};return{onPrepare:function(e){s("progress"),o.textContent=e},onProgress:function(e,t){o.textContent=l.a.i18n.getMessage("vkFoundFiles").replace("%d",e)+" "+l.a.i18n.getMessage("vkFoundOf")+" "+t},onReady:function(){O.a.trigger(i,"kill")},onError:function(e){s("error"),o.textContent=e}}},getLayer:function(){var e=document.getElementById("layer_wrap");return null!==e&&"none"!==e.style.display&&0!==e.textContent.length||(e=null),null===e&&(null!==(e=document.getElementById("wk_layer_wrap"))&&"none"!==e.style.display&&0!==e.textContent.length||(e=null)),e},_getAlbumLinks:function(e,t){var n=this,r=n.photoCache,o="";/albums|tags|photos/.test(location.href)&&(o=Y());var a={},i=[],s=0,u=0,l=0,c=0;return function d(){return function(o){if(t.abort)return Promise.reject(new Error("Abort"));var i={act:"show",al:1,list:e};return o&&(i.offset=o),Object(x.a)({type:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},url:"/al_photos.php",data:i,localXHR:!0,timeout:6e4}).then((function(e){var t=Z(e.body),o=t[6],i=t[8];s||(s=i.length),u=o,l||(l=Math.ceil(o/s));var c=[],d="";return i.forEach((function(e){if(!a[e.id]){a[e.id]=1;var t=n.getMaxPhotoSize(e);t&&(!d&&e.album&&(d=P.a.decodeSpecialChars(Object(m.a)(e.album.replace(/<[^>]+>/g,"")))),t.id=e.id,r[e.id]=t,c.push(t))}})),new Promise((function(e){setTimeout(e,250)})).then((function(){return{title:d,list:c}}))}))}(c*s).then((function(e){if(l--,c++,i.push.apply(i,e.list),t.onProgress&&t.onProgress(i.length,u),o||(o=e.title),l>0)return d()}))}().then((function(){if(Object.keys(r).slice(1e3).forEach((function(e){delete r[e]})),!i.length)throw new Error("Album is empty");return o||(o=Y()),{title:o,list:i}}),(function(e){throw"Abort"!==e.message&&le.debug("Get photo page error!",e),e}))},_getPhotoLinks:function(e,t,n){var r=this;return r._getModuleName().then((function(o){return function(o){if(n.abort)return Promise.reject(new Error("Abort"));var a={act:"show",al:1,list:t,module:o,photo:e};return Object(x.a)({type:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},url:"/al_photos.php",data:a,localXHR:!0,timeout:6e4}).then((function(t){var n=Z(t.body)[8],o=null;if(n.some((function(t){if(t.id===e)return o=r.getMaxPhotoSize(t),!0})),!o)throw new Error("Photo is is not found!");return new Promise((function(e){setTimeout(e,250)})).then((function(){return o}))}))}(o)})).catch((function(e){throw"Abort"!==e.message&&le.debug("Get photo error!",e),e}))},_getModuleName:function(){return new Promise((function(e,t){var n=S.a.create("script",{text:'(function(dataArg){if(window.cur&&window.cur.module&&typeof window.cur.module==="string"){document.body.dataset[dataArg]=window.cur.module}})('+JSON.stringify("sfModule")+");"});document.body.appendChild(n),setTimeout((function(){n.parentNode.removeChild(n),e(document.body.dataset.sfModule)}),0)}))},_getAlbumLinksViaDom:function(e,t){var n=this,r=n.photoCache;if(t.abort)return Promise.reject(new Error("Abort"));var o=/showPhoto\s*\(\s*["']([-\d_]+)["']\s*,\s*["']([\w\-]+)["']/i,a=/\{["']?temp["']?\s*:\s*(\{.+?\})/i,i=/(\{|,)\s*(\w+)\s*:/gi,s={},u=[],l=function(e){if(!de.isReply(e)&&!te.elIsHidden(e)){var t=e.getAttribute("onclick"),r=o.exec(t);if(r){var l=r[1];if(!s[l]){s[l]=1;var c=r[2],d=null,f=a.exec(t);if(f){f=f[1].replace(i,'$1"$2":');var p=null;try{p=JSON.parse(f)}catch(e){}d=p&&n.getMaxPhotoSize(p)}d||(d={}),d.id=l,d.listId=c,u.push(d)}}}};if([].slice.call(e.querySelectorAll("a[onclick]")).forEach(l),0===u.length&&e!==document){var c=n.getWallPostContent();c&&[].slice.call(c.querySelectorAll("a[onclick]")).forEach(l)}return function(e){var o=Promise.resolve(),a=[],i=e.filter((function(e){var t=r[e.id];return!t||(a.push(t),!1)}));return t.onProgress&&t.onProgress(a.length,e.length),i.forEach((function(i){o=o.then((function(){return n._getPhotoLinks(i.id,i.listId,t).then((function(n){r[i.id]=n,a.push(n),t.onProgress&&t.onProgress(a.length,e.length)}),(function(n){if("Abort"===n.message)throw n;i.url&&(a.push(i),t.onProgress&&t.onProgress(a.length,e.length),le.debug("Photo link from dom",n))}))}))})),o=o.then((function(){if(Object.keys(r).slice(1e3).forEach((function(e){delete r[e]})),!a.length)throw new Error("Photos is not found");return{list:a}}))}(u)},_getLinks:function(e,t){var r=this,o=Promise.resolve(),a={},i=r.getPopup(Y(),"photo",(function(){a.abort=!0}));a.onProgress=function(e,t){i.onProgress(e,t)},i.onPrepare(l.a.i18n.getMessage("download")+" ...");var s=function(){if((e=e||document)===document){var t=r.getLayer();t&&(e=t)}return r._getAlbumLinksViaDom(e,a)};return o=(o=t?o.then((function(){return r._getAlbumLinks(t,a)})).catch((function(e){throw"Album is empty"!==e.message&&"Abort"!==e.message&&le.debug("findAlbumLinks error",e),e})).catch((function(){return s()})):o.then(s)).then((function(e){var t=e.title,o=function(e){var t=[];e.forEach((function(e){var n=e.url,o=r.getFilenameFromUrl(n);o||(o="unknown.jpg"),t.push({filename:o,url:n})}));var n=String(t.length).length;return t.forEach((function(e,t){for(var r=String(t+1);r.length<n;)r="0"+r;e.filename=r+"-"+e.filename})),t}(e.list);i.onReady(),t||(t=Y()),d?n.downloadList.showBeforeDownloadPopup(o,{count:o.length,folderName:t,type:"photo",onShowList:function(){r.showListOfLinks(t,o,!0)}}):r.showListOfLinks(t,o,!0)}),(function(e){"Abort"!==e.message&&le.debug("_getLinks error",e),i.onError(l.a.i18n.getMessage("noLinksFound"))}))},rmPhotoAlbumDlBtn:function(){for(var e,t=document.querySelectorAll([".sf-dl-ablum-btn-divide",".sf-dl-ablum-btn"]),n=0;e=t[n];n++)e.parentNode.removeChild(e)},addNewPhotoAlbumDlBtn:function(e){var t=this,n=e.querySelector(".photos_album_intro_info"),r=e.querySelector(".page_block_header_extra"),o=n||r;if(o&&!o.querySelector(".sf-dl-ablum-btn")){var a=S.a.create("a",{text:l.a.i18n.getMessage("vkDownloadPhotoAlbum"),href:"#",class:"sf-dl-ablum-btn",on:["click",function(n){n.preventDefault();var r=de.getAlbumId(location.href);t._getLinks(e,r)}]}),i=S.a.create("span",{append:a});n?(i.classList.add("photos_album_info"),i=S.a.create(document.createDocumentFragment(),{append:[S.a.create("span",{class:"divide sf-dl-ablum-btn-divide",text:"|"}),i]})):r&&(i.classList.add("photos_comments_link"),i.style.margin="0 15px"),o.appendChild(i)}},getContainer:function(){var e=document.getElementById("photos_albums_container");return e||(e=document.getElementById("photos_container")),e},getFilenameFromUrl:function(e){var t=/\/([\w\-]+\.[a-z0-9]{3,4})(?:\?|$)/i.exec(e);return t=t&&t[1]||""},rmCurrentPhotoBtn:function(e){for(var t,n=void 0,r=document.querySelectorAll(".sf-dl-current-photo-btn"),o=0;t=r[o];o++)e&&e.contains(t)?n=t:t.parentNode.removeChild(t);return n},style:null,injectStyle:function(){this.style?this.style.parentNode||document.head.appendChild(this.style):(this.style=S.a.create("style",{text:Object(b.a)({"div > .sf-dl-current-photo-btn":{display:"none",border:"1px solid #F8F8F8",width:"20px",height:"20px",padding:0,position:"absolute",background:"url("+n.svg.getSrc("download","#777777")+") center no-repeat #F8F8F8",backgroundSize:"12px",top:"20px",left:"30px",zIndex:10,cursor:"pointer"},"div > .sf-dl-current-photo-btn.sf-style-black":{border:0,background:"url("+n.svg.getSrc("download","#FFF")+") center no-repeat #000",backgroundSize:"14px",padding:"2px 4px",borderRadius:"2px",opacity:.4,transition:"opacity 100ms linear"},"div > .sf-dl-current-photo-btn:hover":{background:"url("+n.svg.getSrc("download","#00B75A")+") center no-repeat #F8F8F8",backgroundSize:"12px",opacity:.8},"div > .sf-dl-current-photo-btn.sf-style-black:hover":{background:"url("+n.svg.getSrc("download","#00B75A")+") center no-repeat #000",backgroundSize:"14px"},"div > .sf-dl-current-photo-btn:active":{outline:0,boxShadow:"inset 0 3px 5px rgba(0, 0, 0, 0.125)"},"div:hover > .sf-dl-current-photo-btn":{display:"block"}})}),document.head.appendChild(this.style))},getMaxPhotoSize:function(e){var t=null,n=null;["w","z","y","x"].some((function(r){return!!(t=e[r+"_"])||(!!(n=e[r+"_src"])||void 0)})),t||(t=[n]);var r,o;return t[0]?{url:(r=e.base,o=t[0],o.match(/https?:\/\//i)?((o=new URL(o)).pathname.match(/\.[a-z]{3}$/i)||(o+=".jpg"),o.toString()):(o.match(/\.[a-z]{3}$/i)||(o+=".jpg"),(r||"").replace(/\/[a-z0-9_:\.]*$/i,"")+"/"+o)),width:t[2]&&t[1],height:t[1]&&t[2]}:null},getNewCurrentPhotoLink:function(e,t){var n=this;return e?Object(Q.a)([e],(function(e){var t={};return"undefined"!=typeof cur&&cur.pvCurPhoto&&cur.pvCurPhoto.id===e&&(t=cur.pvCurPhoto),t})).then((function(e){if(!e||!e.id)return t("ID is not found");var r=n.getMaxPhotoSize(e);return r?t(null,r):t("URL is not found!")})):t("ID is empty!")},addNewDlCurrentPhotoBtn:function(e){var t=e;if(!this.rmCurrentPhotoBtn(t)){var r=this,o=e.closest(".pv_photo_wrap");if(o){var a=S.a.create("a",{class:["sf-dl-current-photo-btn","sf-style-black"],href:"#",title:l.a.i18n.getMessage("download"),on:[["click",function(e){if(e.stopPropagation(),e.preventDefault(),O.a.onRemoveEvent(this,X.hideMenu),!X.contextMenu||!X.contextMenu.isShow){var a=X.contextMenu=n.popupMenu.quickInsert(this,l.a.i18n.getMessage("download")+" ...","photoDlMenu",{parent:t}),i=o.querySelector(".like_wrap").classList,s=null;return i.forEach((function(e){var t=e.match(/photo(-?\d+_\d+)/);s=t&&t[1]})),r.getNewCurrentPhotoLink(s,(function(e,t){if(e)return a.update(l.a.i18n.getMessage("noLinksFound"));var n=P.a.modify(r.getFilenameFromUrl(t.url)),o=n.lastIndexOf("."),i=n.substr(o+1),s=n.substr(0,o),u=[];u.push({href:t.url,title:s,quality:l.a.i18n.getMessage("download"),format:" ",ext:i,forceDownload:!0,isOther:!0,isBlank:!0,func:function(){"undefined"!=typeof GM_info&&"Tampermonkey"===GM_info.scriptHandler?setTimeout((function(){return a.hide()}),2500):a.hide()}}),u.push({href:"#getAlbum",title:"",quality:l.a.i18n.getMessage("vkDownloadPhotoAlbum"),format:" ",ext:"",noSize:!0,isOther:!0,func:function(e){e.preventDefault(),de.downloadPhoto(),a.hide()}}),a.update(u)}))}X.hideMenu()}],["mousedown",function(e){e.stopPropagation()}]]});new N.a({queries:[{css:"#pv_photo img",is:"added",callback:function(){X.contextMenu&&X.contextMenu.isShow&&(X.hideMenu(),a.click())}}]}),t.appendChild(a)}}},downloadPhoto:function(){var e=this.getContainer(),t=this.getAlbumId(location.href);if(!t){var n=document.querySelector(".pv_album_name a");n&&!te.elIsHidden(n)&&(t=this.getAlbumId(n.href))}this._getLinks(e,t)},showListOfPhotosContent:function(e,t){var n;return"<!DOCTYPE html><html>"+S.a.create("html",{append:[S.a.create("head",{append:[S.a.create("meta",{attr:{charset:"utf-8"}}),S.a.create("style",{text:"a,img{display:block;margin-bottom:5px;}p{width: 640px}"})]}),S.a.create("body",{append:[e,S.a.create("p",{text:l.a.i18n.getMessage("vkListOfPhotosInstruction")}),S.a.create("br"),S.a.create("br"),(n=document.createDocumentFragment(),t.forEach((function(e){var t=e.url,r=e.filename||"",o=S.a.create("img",{src:t,alt:"photo"});r&&(o=S.a.create("a",{href:t,download:r,append:o})),n.appendChild(o)})),n)]})]}).innerHTML+"</html>"},showListOfLinks:function(e,t,r){var o;o=r?S.a.create(document.createDocumentFragment(),{append:[S.a.create("p",{append:[S.a.create("a",{text:l.a.i18n.getMessage("vkListOfPhotos"),href:"#",class:"sf__hidden",style:{fontWeight:"bolder",border:"none",textDecoration:"underline"},on:["click",function(n){n.preventDefault();var r=de.showListOfPhotosContent(e,t),o="";l.a.isChrome||l.a.isTM?(o=Object(k.a)(r,"text/html",!0),l.a.sendMessage({action:"openTab",url:o})):(o=Object(k.a)(r,"text/html"),window.open(o,"_blank"))}]})]})]}):"";for(var a,i,s="",u=0;a=t[u];u++)s+=a.url+"\r\n";var c=S.a.create(document.createDocumentFragment(),{append:[S.a.create("p",{text:e,style:{color:"#0D0D0D",fontSize:"20px",marginBottom:"11px",marginTop:"5px"}}),S.a.create("p",{append:Object(A.a)(l.a.i18n.getMessage("vkListOfLinksInstruction"))}),o,i=S.a.create("textarea",{text:s,cols:60,rows:10,style:{width:"100%"}}),l.a.isChrome||l.a.isFirefox?S.a.create("button",{text:l.a.i18n.getMessage("copy"),style:{height:"27px",backgroundColor:"#ffffff",border:"1px solid #9e9e9e",marginTop:"6px",paddingLeft:"10px",paddingRight:"10px",borderRadius:"5px",fontSize:"14px",cursor:"pointer",cssFloat:"right"},on:["click",function(e){var t=this;t.disabled=!0,l.a.isFirefox?(i.select(),document.execCommand("copy")):l.a.sendMessage({action:"addToClipboard",text:s}),setTimeout((function(){t.disabled=!1}),1e3)}],append:S.a.create("style",{text:Object(b.a)({"#savefrom_popup_box button:hover:not(:disabled)":{backgroundColor:"#597A9E !important",borderColor:"#597A9E !important",color:"#fff"},"#savefrom_popup_box button:active":{opacity:.9}})})}):void 0]});n.popupDiv(c)}},fe={mobileMenu:null,observer:null,styleEl:null,run:function(){var e=this;if(N.a.isAvailable()){if(e.observer)return e.observer.start();e.observer=new N.a({queries:[{css:"div.audio_item",is:"added",callback:function(t){for(var n,r=0;n=t.added[r];r++)n.dataset.sfSkip>0||(n.dataset.sfSkip="1",e.insertAudioBtn(n))}},{css:"div.VideoPage",is:"added",callback:function(t){for(var n,r=0;n=t.added[r];r++)n.dataset.sfSkip>0||(n.dataset.sfSkip="1",e.insertVideoBtn(n))}},{css:"."+O.a.onRemoveClassName,is:"removed",callback:function(e){for(var t,n=0;t=e.removed[n];n++)O.a.onRemoveListener(t)}}]}),e.insertStyle()}},hideMenu:function(){fe.mobileMenu&&(fe.mobileMenu.hide(),fe.mobileMenu=null)},insertStyle:function(){this.styleEl?this.styleEl.parentNode||document.head.appendChild(this.styleEl):(this.styleEl=S.a.create("style",{class:"sf-style",text:Object(b.a)([{selector:".savefrom_vk_download.sf-audio",style:{display:"block",float:"right",borderRadius:"3px",width:"22px",height:"22px",marginTop:"1px",marginLeft:"3px",marginRight:"3px",background:"url("+n.svg.getSrc("download","#ffffff")+") center no-repeat",backgroundSize:"12px",backgroundColor:"#5E80AA"}},{selector:".audio_item .savefrom_vk_download.sf-audio",style:{position:"absolute",right:"32px",top:0,bottom:0,margin:"auto"}},{selector:".audio_item.ai_current .savefrom_vk_download.sf-audio",style:{bottom:"auto",top:"6px"}}])}),document.head.appendChild(this.styleEl))},getAudioUrlFromNode:(E=Object(i.a)(u.a.mark((function e(t){var n,r,o;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,te.getNewNodeTrackInfo(t);case 2:if((n=e.sent).fullId&&n.actionHash&&n.urlHash){e.next=5;break}throw new Error("Track info not valid for fetch audio link");case 5:return r=te.requestReloadAudio(n.fullId,n.actionHash,n.urlHash),o=Object(Q.a)([],"function(){return vk.id}"),e.abrupt("return",Promise.all([r,o]).then((function(e){var t=Object(a.a)(e,2),n=t[0],r=F(t[1],n.url);return D(r)?q(r):r})));case 8:case"end":return e.stop()}}),e)}))),function(e){return E.apply(this,arguments)}),onAudioBtnClick:function(e){if(e.preventDefault(),e.stopPropagation(),e.target.href)return n.downloadOnClick(e);var t=e.target.closest(".audio_item");t&&this.getAudioUrlFromNode(t).then((function(t){e.target.href=t,n.downloadOnClick(e)})).catch((function(e){le.error("getAudioUrlFromNode error: "+e.message)}))},getAudioDlBtnNode:function(e){return S.a.create("a",{class:["savefrom_vk_download","sf-audio"],download:P.a.modify(e),target:"_blank",on:["click",this.onAudioBtnClick.bind(this)],title:l.a.i18n.getMessage("download")})},insertAudioBtn:function(e){var t=null,n=e.querySelector(".ai_label");if(n){var r=n.textContent.trim(),o=n.querySelector(".ai_title"),a=n.querySelector(".ai_artist"),i=o&&o.textContent.trim(),s=a&&a.textContent.trim();t=i&&s?"".concat(s.trim(),"  ").concat(i.trim()):r}t="".concat(t||"unknown",".mp3");var u=e.querySelector(".ai_dur");if(u){var l=u.parentNode,c=this.getAudioDlBtnNode(t),d=l.querySelector(".savefrom_vk_download");if(d)d.parentNode.replaceChild(c,d);else{var f=u.nextElementSibling;if(!f)return;l.insertBefore(c,f)}}},onVideoBtnClick:function(e,t){t.preventDefault(),t.stopPropagation(),fe.hideMenu();var r=fe.mobileMenu=n.mobileLightBox.show(l.a.i18n.getMessage("download")+" ..."),o=l.a.i18n.getMessage("noLinksFound");if(e.request){var a=function(t){if(t&&"getPladformVideo"===e.request.action)o=ne.prepareLinks(ne.preparePladformLinks(t));else{var a=n.embedDownloader.reMapHosting(t.action);a&&t&&t.links&&(o=n.popupMenu.prepareLinks[a](t.links,t.title))}if(!o.length){var i=Array.from(document.body.querySelectorAll('.vv_inline_video source[type="video/mp4"]'));o=i.map((function(e){var t=document.querySelector(".VideoPageInfoRow__title"),n=e.src.match(/.(\d+)\.mp4/);return{title:t?t.textContent:"video",href:e.src,forceDownload:!0,ext:"mp4",format:"MP4",quality:n?n[1]:""}}))}r.update(o)};try{l.a.sendMessage(e.request,a)}catch(t){a()}}else o=ne.prepareLinks(e),r.update(o)},appendVideoBtn:function(e,t){var r=t.querySelector(".VideoPageInfoRow__title"),o=n.svg.getSvg("download","#4986cc","20px");o.style.marginLeft="17px",o.style.marginTop="6px",o.style.float="right",o.style.cursor="pointer",o.addEventListener("click",this.onVideoBtnClick.bind(this,e)),r&&r.appendChild(o),O.a.onRemoveEvent(o,fe.hideMenu)},insertVideoBtn:function(e){var t=this,n=e.querySelectorAll("iframe, video, a")[0],r=Object(p.a)(e,"VideoPage"),o=function(){var e=/video(-?\d+)_(-?\d+)/.exec(location.href);return e&&{request:{hosting:"vk",action:"getVKLinks",extVideoId:"video"+e[1]+"_"+e[2]}}};n?ne.getLinksFromPlayer(r,n,(function(e,n){e||(e=o()),e&&t.appendVideoBtn(e,n)})):e.querySelector(".vv_not_support")&&o()&&t.appendVideoBtn(o(),r)}}}))}});