import{g as E,c as y,D as M,o as _,d as b}from"./analytics-46c41402.js";import{v as S}from"./backend-b5a741e2.js";import{b as B,c as h,f as U,u as D,a as p,d as x,r as k,s as v,o as F,e as H,i as I}from"./index-dbfb7ba1.js";import{D as t,L as r}from"./index-825701e8.js";import{c as R,e as Y}from"./webAccess-fb5e9839.js";import{x as $,y as O,z as w,B as N,A as o,k as P,G,I as W}from"./index-9b1f0f42.js";import"./purify.es-8e338605.js";import"./utils-f7fcf05a.js";const A=async e=>{try{let s="";return await fetch(e).then(a=>{if(!a.ok)throw new Error("Network response was not ok");return a.text()}).then(a=>{s=a}).catch(a=>console.error(`Fetch Error: ${a}`)),s}catch{return""}};var T=(e=>(e.YOUTUBE_BTN="YOUTUBE_BTN",e.YOUTUBE_SUMMARY="YOUTUBE_SUMMARY",e.BACKGROUND="BACKGROUND",e.YOUTUBE_PAGE_FOREGROUND="YOUTUBE_PAGE_FOREGROUND",e.YOUTUBE_PAGE_MOUNT_REQUEST="YOUTUBE_PAGE_MOUNT_REQUEST",e))(T||{});const C=async e=>{let s;if(e.tab)s=e.tab.id;else{const[a]=await t.tabs.query({active:!0,lastFocusedWindow:!0});s=a.id}if(s!==void 0)return s},K=()=>{t.runtime.onMessage.addListener(async(e,s)=>{const a=await C(s);e.from===T.YOUTUBE_BTN&&t.tabs.sendMessage(a,{action:"YOUTUBE_BTN_CLICKED",from:T.BACKGROUND}),e.from===T.YOUTUBE_SUMMARY&&e.action==="SEND_BATCH_LENGTH"&&t.tabs.sendMessage(a,{action:"SEND_BATCH_LENGTH",data:e.data,from:T.BACKGROUND})}),t.runtime.onMessageExternal.addListener(async(e,s)=>{const a=await C(s);e.from===T.YOUTUBE_PAGE_FOREGROUND&&t.tabs.sendMessage(a,{action:"SEND_CAPTIONS",data:e.data,from:T.BACKGROUND})})};B();function L(e){return Math.floor(Math.random()*10)===0?e():!1}t.runtime.onInstalled.addListener(async e=>{h();const s=t.runtime.getManifest().version,a=`extensionVersion=${s}&clientId=${await E()}&sessionId=${await y()}`;if(r.set("extVersion",s),r.set("tglMountPreference",!0),e.reason==="install"){L(()=>fetch(`${W}?${a}`)),t.tabs.create({url:$}),t.runtime.setUninstallURL(`${O}?${a}`);const c=await(await fetch(`${w.DOMAIN}/getCountryCategory`)).json();r.set("UserSettings",N),r.set("userThemePreference","system"),r.set("CountryCategory",c.countryCategory),r.set("installTimestamp",Date.now());const m={engagement_time_msec:M,session_id:await y(),timestamp:JSON.stringify(Date.now())};U({client_id:await E(),events:[{name:"ExtensionInstalled",params:m}]})}if(t.contextMenus.create({contexts:["selection"],id:"merlinExtContextBtn",title:"Give context to Merlin"}),e.reason==="update"){t.runtime.setUninstallURL(`${O}?${a}`),L(()=>fetch(`${G}?${a}`));try{const n=await r.get("UserSettings");if(n){const l={};n.hasOwnProperty("preferredOpenAiModel")&&(l.preferredOpenAiModel=n.preferredOpenAiModel),n.hasOwnProperty("language")&&(l.language=n.language),n.hasOwnProperty("mode")&&(l.mode=n.mode),n.hasOwnProperty("apikey")&&(l.apikey=n.apikey),n.hasOwnProperty("webAccessEnabled")?l.webAccessMode={id:"turbo",name:"Turbo"}:l.webAccessMode={id:"off",name:"Off"};const i=await r.get("authDetails")}}catch(n){console.error(n)}let d=await r.get("UserSettings");if(d||(d={}),D(d,N),await r.set("UserSettings",d),await r.get("hasSeenQueryModal")!=="seenOnce"&&await r.set("hasSeenQueryModal","notSeen"),!await r.get("CountryCategory")){const l=await(await fetch(`${w.DOMAIN}/getCountryCategory`)).json();r.set("CountryCategory",l.countryCategory)}const m=await r.get("tglMountPreference");m!=!0&&m!=!1&&await r.set("tglMountPreference",!0)}});t.runtime.onConnectExternal.addListener(function(e){e.onMessage.addListener(function(s){s.action===o.WEB_ACCESS.GET_HTML_FROM_URL&&R(s.payload.url,s.payload.successfulGet,s.payload.timeout).then(a=>e.postMessage(a))})});t.runtime.onMessageExternal.addListener(async(e,s)=>{var a,d,c,m,n,l;if(e.action==="PING")return{action:"PONG"};if(e.from===P.MERLIN_APP){if(e.action===o.APP_REQUEST.SIGNIN&&(e.payload.closeTab&&t.tabs.remove(s.tab.id),(a=e.payload)!=null&&a.session)){const i=await S((d=e.payload)==null?void 0:d.session.accessToken);if(i){const u=(m=(c=_(e.payload.session.accessToken))==null?void 0:c.details)==null?void 0:m.name,f=(l=(n=_(e.payload.session.accessToken))==null?void 0:n.details)==null?void 0:l.email;p({email:f,isAuthenticated:!0,isLoading:!1,name:u,session:{refreshToken:e.payload.session.refreshToken},token:e.payload.session.accessToken,usageDetails:{...i.user}});const g={engagement_time_msec:M,session_id:await y(),timestamp:JSON.stringify(Date.now()),user_id:await b()};U({client_id:await E(),events:[{name:"UserSignin",params:g}]})}else p({isLoading:!1})}if(e.action===o.APP_REQUEST.SIGNOUT&&(p({...I,isAuthenticated:!1,isLoading:!1}),r.remove("cacheStorage").catch(()=>{})),e.action===o.OPEN_OPTIONS_PAGE){const i=t.runtime.getURL("src/options/index.html");t.tabs.update({url:i})}e.action===o.CHAT_WEBPAGE&&t.tabs.create({url:"https://getmerlin.in/chat"})}});t.commands.onCommand.addListener(async e=>{const s={active:!0,currentWindow:!0},a=await t.tabs.query(s);e==="toggle_merlin"&&t.tabs.sendMessage(a[0].id,{data:{from:"hotKey"}}).catch(()=>{(a[0].url.includes("chrome://")||a[0].url.includes("extension://")&&a[0].url!=="https://getmerlin.in/chat"||a[0].url==="about:blank")&&t.tabs.create({url:"https://getmerlin.in/chat"})})});t.contextMenus.onClicked.addListener(async e=>{if(e.menuItemId==="merlinExtContextBtn"){const s={active:!0,currentWindow:!0},a=await t.tabs.query(s);t.tabs.sendMessage(a[0].id,{data:{data:{selectionText:e.selectionText},from:"contextMenu"}})}});t.action.onClicked.addListener(e=>{e.url!=="https://getmerlin.in/chat"&&(e.url.includes("chrome://")||e.url.includes("edge://")||e.url.includes("extension://")?e.url.includes("shortcut")||t.tabs.create({url:"https://getmerlin.in/chat"}):(async()=>{const s=await t.tabs.query({active:!0,currentWindow:!0});try{t.tabs.sendMessage(s[0].id,{data:{from:"extPopupButton"}})}catch{t.action.setPopup({popup:t.runtime.getURL("/popup.html"),tabId:e.id})}})())});t.runtime.onMessage.addListener(async(e,s)=>{var a,d,c,m;if(e.action==="PING")return{action:"PONG"};if(e.action==="POLLING")return{action:"ACTIVE"};if(e.action===o.OPEN_OPTIONS_PAGE&&t.runtime.openOptionsPage(),e.from==="selectContextBtn"&&x(e),e.from===P.CONTENT_SCRIPT){if(e.action===o.AUTH.REFRESH_TOKEN&&await k(),e.action===o.AUTH.SYNC_USAGE&&await v(),e.action==="SIGN_IN_VIA_CUSTOM_EVENT"&&(e.payload.closeTab&&t.tabs.remove(s.tab.id),(a=e.payload)!=null&&a.session)){const n=await S((d=e.payload)==null?void 0:d.session.accessToken);if(n){const l=(m=(c=_(e.payload.session.accessToken))==null?void 0:c.details)==null?void 0:m.name;p({isAuthenticated:!0,isLoading:!1,name:l,session:{refreshToken:e.payload.session.refreshToken},token:e.payload.session.accessToken,usageDetails:{...n.user}})}else p({isLoading:!1})}e.action==="SIGN_OUT_VIA_CUSTOM_EVENT"&&(p({...I,isAuthenticated:!1,isLoading:!1}),r.remove("cacheStorage").catch(()=>{}))}if(e.action===o.NEW_TAB&&F(e.payload.url),e.action===o.BROWSER.CHECK_SHORTCUT){const n=await h();t.tabs.sendMessage(s.tab.id,{data:{key:n}})}e.action===o.ANALYTICS&&U(e.payload),e.action===o.UNINSTALL_URL&&await H(e.payload)});t.storage.onChanged.addListener(async(e,s)=>{if(s==="local")for(const a in e){const d=e[a],{newValue:c,oldValue:m}=d;if(c&&c!==m&&(c==null?void 0:c.status)==="pending"){const{action:n,id:l,payload:i}=c;let u=null;if(n===o.FETCH_TEXT){let f;try{f=await(await fetch(i.url,i.options)).text()}catch{f=null}u=f}if(n===o.FETCH_JSON){let f;try{f=await(await fetch(i.url,i.options)).json()}catch{f=null}u=f}if(n===o.GET_GOOGLE_COMPLETION)if(!i.query)u=null;else try{u=(await(await fetch(new URL("http://suggestqueries.google.com/complete/search?client=chrome&q="+i.query))).json())[1]}catch{u=null}if(n===o.GET_GOOGLE_COMPLETION_V2)if(!i.query)u=null;else try{u=(await(await fetch("https://www.google.com/complete/search?"+new URLSearchParams({client:"chrome",output:"chrome",q:i.query+" > "}))).json())[1]}catch{u=null}n===o.BROWSER.CHECK_SHORTCUT&&(u=await h()),n===o.WEB_ACCESS.GET_HTML_FROM_URL&&(u=await R(i.url,i.successfulGet,i.timeout)),n===o.GET_PR_DIFF&&(u=await A(i.url)),n===o.GET_PR_PATCH&&(u=await A(i.urlPatch)),n===o.EXTRACT_DOM&&(u=await Y(i.url)),t.storage.local.set({[l]:{...c,response:u,status:"fulfilled"}}).then(()=>{t.runtime.lastError&&console.error(t.runtime.lastError)},f=>{t.storage.local.set({[l]:{...c,response:null,status:"fulfilled"}})})}}});K();t.runtime.onUpdateAvailable.addListener(()=>{t.tabs.query({}).then(e=>{e.length<3&&(fetch(`${G}?extensionVersion=${t.runtime.getManifest().version}&forceUpdate=true`),t.runtime.reload())})});t.storage.local.get(null).then(e=>{for(const s in e)/^getFromBackground-/.test(s)&&t.storage.local.remove(s)});
