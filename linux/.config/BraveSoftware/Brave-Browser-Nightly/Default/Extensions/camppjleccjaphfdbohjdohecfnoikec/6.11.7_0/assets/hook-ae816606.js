var T=Object.defineProperty;var j=(e,t,s)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var r=(e,t,s)=>(j(e,typeof t!="symbol"?t+"":t,s),s),W=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)};var a=(e,t,s)=>(W(e,t,"read from private field"),s?s.call(e):t.get(e)),o=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},f=(e,t,s,i)=>(W(e,t,"write to private field"),i?i.call(e,s):t.set(e,s),s);var z=(e,t,s)=>(W(e,t,"access private method"),s);import{r as u}from"./client-45b27fd3.js";import{N as U}from"./index-9b1f0f42.js";var $=()=>{var e,t,s;try{let i=((e=globalThis.navigator)==null?void 0:e.userAgent).match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(i[1]==="Chrome")return parseInt(i[2])<100||((s=(t=globalThis.chrome.runtime)==null?void 0:t.getManifest())==null?void 0:s.manifest_version)===2}catch{return!1}return!1},m,l,c,K,p,x,N,k,E,F,V,G,R,J=(R=class{constructor({area:e="sync",allCopied:t=!1,copiedKeyList:s=[],serde:i={}}={}){o(this,E);o(this,V);o(this,m,void 0);o(this,l,void 0);o(this,c,void 0);o(this,K,void 0);o(this,p,new Map);o(this,x,void 0);r(this,"isCopied",e=>this.hasWebApi&&(this.allCopied||this.copiedKeySet.has(e)));o(this,N,!1);r(this,"getExtStorageApi",()=>{var e,t;return((e=globalThis.browser)==null?void 0:e.storage)||((t=globalThis.chrome)==null?void 0:t.storage)});r(this,"isWatchSupported",()=>this.hasExtensionApi);r(this,"keyNamespace","");r(this,"isValidKey",e=>e.startsWith(this.keyNamespace));r(this,"getNamespacedKey",e=>`${this.keyNamespace}${e}`);r(this,"getUnnamespacedKey",e=>e.slice(this.keyNamespace.length));r(this,"serde",{serializer:JSON.stringify,deserializer:JSON.parse});r(this,"rawGetAll",()=>{var e;return(e=a(this,l))==null?void 0:e.get()});r(this,"getAll",async()=>{let e=await this.rawGetAll();return Object.entries(e).filter(([t])=>this.isValidKey(t)).reduce((t,[s,i])=>(t[this.getUnnamespacedKey(s)]=i,t),{})});r(this,"copy",async e=>{var n,h;let t=e===void 0;if(!t&&!this.copiedKeySet.has(e)||!this.allCopied||!this.hasExtensionApi)return!1;let s=this.allCopied?await this.rawGetAll():await a(this,l).get((t?[...this.copiedKeySet]:[e]).map(this.getNamespacedKey));if(!s)return!1;let i=!1;for(let d in s){let w=s[d],g=(n=a(this,c))==null?void 0:n.getItem(d);(h=a(this,c))==null||h.setItem(d,w),i||(i=w!==g)}return i});r(this,"rawGet",async e=>{var t;return this.hasExtensionApi?(await a(this,l).get(e))[e]:this.isCopied(e)?(t=a(this,c))==null?void 0:t.getItem(e):null});r(this,"rawSet",async(e,t)=>{var s;return this.isCopied(e)&&((s=a(this,c))==null||s.setItem(e,t)),this.hasExtensionApi&&await a(this,l).set({[e]:t}),null});r(this,"clear",async(e=!1)=>{var t;e&&((t=a(this,c))==null||t.clear()),await a(this,l).clear()});r(this,"rawRemove",async e=>{var t;this.isCopied(e)&&((t=a(this,c))==null||t.removeItem(e)),this.hasExtensionApi&&await a(this,l).remove(e)});r(this,"removeAll",async()=>{let e=await this.getAll(),t=Object.keys(e);await Promise.all(t.map(this.remove))});r(this,"watch",e=>{let t=this.isWatchSupported();return t&&a(this,k).call(this,e),t});o(this,k,e=>{var t;for(let s in e){let i=this.getNamespacedKey(s),n=((t=a(this,p).get(i))==null?void 0:t.callbackSet)||new Set;if(n.add(e[s]),n.size>1)continue;let h=(d,w)=>{if(w!==this.area||!d[i])return;let g=a(this,p).get(i);if(!g)throw new Error(`Storage comms does not exist for nsKey: ${i}`);Promise.all([this.parseValue(d[i].newValue),this.parseValue(d[i].oldValue)]).then(([v,S])=>{for(let A of g.callbackSet)A({newValue:v,oldValue:S},w)})};a(this,m).onChanged.addListener(h),a(this,p).set(i,{callbackSet:n,listener:h})}});r(this,"unwatch",e=>{let t=this.isWatchSupported();return t&&z(this,E,F).call(this,e),t});r(this,"unwatchAll",()=>z(this,V,G).call(this));this.setCopiedKeySet(s),f(this,K,e),f(this,N,t),this.serde={...this.serde,...i};try{this.hasWebApi&&(t||s.length>0)&&f(this,c,window.localStorage)}catch{}try{this.hasExtensionApi&&(f(this,m,this.getExtStorageApi()),$()?f(this,l,U(a(this,m)[this.area],{exclude:["getBytesInUse"],errorFirst:!1})):f(this,l,a(this,m)[this.area]))}catch{}}get primaryClient(){return a(this,l)}get secondaryClient(){return a(this,c)}get area(){return a(this,K)}get hasWebApi(){try{return typeof window<"u"&&!!window.localStorage}catch(e){return console.error(e),!1}}get copiedKeySet(){return a(this,x)}get allCopied(){return a(this,N)}get hasExtensionApi(){try{return!!this.getExtStorageApi()}catch(e){return console.error(e),!1}}setCopiedKeySet(e){f(this,x,new Set(e))}async getItem(e){return this.get(e)}async setItem(e,t){await this.set(e,t)}async removeItem(e){return this.remove(e)}},m=new WeakMap,l=new WeakMap,c=new WeakMap,K=new WeakMap,p=new WeakMap,x=new WeakMap,N=new WeakMap,k=new WeakMap,E=new WeakSet,F=function(e){for(let t in e){let s=this.getNamespacedKey(t),i=e[t],n=a(this,p).get(s);n&&(n.callbackSet.delete(i),n.callbackSet.size===0&&(a(this,p).delete(s),a(this,m).onChanged.removeListener(n.listener)))}},V=new WeakSet,G=function(){a(this,p).forEach(({listener:e})=>a(this,m).onChanged.removeListener(e)),a(this,p).clear()},R),M=class extends J{constructor(){super(...arguments);r(this,"get",async t=>{let s=this.getNamespacedKey(t),i=await this.rawGet(s);return this.parseValue(i)});r(this,"set",async(t,s)=>{let i=this.getNamespacedKey(t),n=this.serde.serializer(s);return this.rawSet(i,n)});r(this,"remove",async t=>{let s=this.getNamespacedKey(t);return this.rawRemove(s)});r(this,"setNamespace",t=>{this.keyNamespace=t});r(this,"parseValue",async t=>{try{if(t!==void 0)return this.serde.deserializer(t)}catch(s){console.error(s)}})}};function q(e,t){let s=typeof e=="object",i=s?e.key:e,[n,h]=u.useState(t),[d,w]=u.useState(!0),g=u.useRef(!1),v=u.useRef(t instanceof Function?t():t);u.useEffect(()=>{v.current=n},[n]);let S=u.useRef(s?e.instance:new M),A=u.useCallback(y=>S.current.set(i,y!==void 0?y:v.current),[i]),I=u.useCallback(async y=>{let b=y instanceof Function?y(v.current):y;await A(b),g.current&&h(b)},[A]);u.useEffect(()=>{var b;g.current=!0;let y={[i]:C=>{g.current&&(h(C.newValue),w(!1))}};return S.current.watch(y),(b=S.current.get(i))==null||b.then(C=>{if(t instanceof Function){let L=t==null?void 0:t(C,!0);L!==void 0&&I(L)}else h(C!==void 0?C:t);w(!1)}),()=>{g.current=!1,S.current.unwatch(y),t instanceof Function&&h(t)}},[i,I]);let O=u.useCallback(()=>{S.current.remove(i),h(void 0)},[i]);return[n,I,{setRenderValue:h,setStoreValue:A,remove:O,isLoading:d}]}export{q as L};
