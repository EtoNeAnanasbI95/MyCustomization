import{r as m}from"./client-45b27fd3.js";import{q as B,v as V,t as z}from"./backend-b5a741e2.js";import{a as J}from"./index-37dc4817.js";import{L as F}from"./index-825701e8.js";import{E as A}from"./index-9b1f0f42.js";import{u as G}from"./useAsyncWithPromise-6dde1473.js";async function Q(s,r){const e=s.getReader();let a;for(;!(a=await e.read()).done;)r(a.value)}function X(s){let r,e,a,o=!1;return function(d){r===void 0?(r=d,e=0,a=-1):r=Z(r,d);const i=r.length;let c=0;for(;e<i;){o&&(r[e]===10&&(c=++e),o=!1);let u=-1;for(;e<i&&u===-1;++e)switch(r[e]){case 58:a===-1&&(a=e-c);break;case 13:o=!0;case 10:u=e;break}if(u===-1)break;s(r.subarray(c,u),a),c=e,a=-1}c===i?r=void 0:c!==0&&(r=r.subarray(c),e-=c)}}function Y(s,r,e){let a=q();const o=new TextDecoder;return function(d,i){if(d.length===0)e==null||e(a),a=q();else if(i>0){const c=o.decode(d.subarray(0,i)),u=i+(d[i+1]===32?2:1),O=o.decode(d.subarray(u));switch(c){case"data":a.data=a.data?a.data+`
`+O:O;break;case"event":a.event=O;break;case"id":s(a.id=O);break;case"retry":const y=parseInt(O,10);isNaN(y)||r(a.retry=y);break}}}}function Z(s,r){const e=new Uint8Array(s.length+r.length);return e.set(s),e.set(r,s.length),e}function q(){return{data:"",event:"",id:"",retry:void 0}}var k=globalThis&&globalThis.__rest||function(s,r){var e={};for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&r.indexOf(a)<0&&(e[a]=s[a]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,a=Object.getOwnPropertySymbols(s);o<a.length;o++)r.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(s,a[o])&&(e[a[o]]=s[a[o]]);return e};const U="text/event-stream",ee=1e3,C="last-event-id";function te(s,r){var{signal:e,headers:a,onopen:o,onmessage:l,onclose:d,onerror:i,openWhenHidden:c,fetch:u}=r,O=k(r,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((y,D)=>{const h=Object.assign({},a);h.accept||(h.accept=U);let b;function T(){b.abort(),document.hidden||v()}c||document.addEventListener("visibilitychange",T);let R=ee,S=0;function _(){document.removeEventListener("visibilitychange",T),window.clearTimeout(S),b.abort()}e==null||e.addEventListener("abort",()=>{_(),y()});const P=u??window.fetch,x=o??re;async function v(){var M;b=new AbortController;try{const E=await P(s,Object.assign(Object.assign({},O),{headers:h,signal:b.signal}));await x(E),await Q(E.body,X(Y(w=>{w?h[C]=w:delete h[C]},w=>{R=w},l))),d==null||d(),_(),y()}catch(E){if(!b.signal.aborted)try{const w=(M=i==null?void 0:i(E))!==null&&M!==void 0?M:R;window.clearTimeout(S),S=window.setTimeout(v,w)}catch(w){_(),D(w)}}}v()})}function re(s){const r=s.headers.get("content-type");if(!(r!=null&&r.startsWith(U)))throw new Error(`Expected content-type to be ${U}, Actual: ${r}`)}const ae=1,fe=(s,r,e,a=!1)=>{var M,E,w;const[o,l]=m.useState(a?"pending":"idle"),[d,i]=m.useState(null),c=m.useRef(null),u=m.useRef([]),O=m.useRef(0),y=B.getQueryData(["sharedUserSettings"]),D=(M=y==null?void 0:y.apiKey)!=null&&M.enabled&&((E=y==null?void 0:y.apiKey)!=null&&E.value)?{apiKey:(w=y==null?void 0:y.apiKey)==null?void 0:w.value}:{},{getUsageDetails:h}=G(V,"getUsageDetails",!1),{signOut:b,updateAuthDetails:T,...R}=m.useContext(J),S=m.useCallback(async()=>{try{const f=await z(R.session.refreshToken,"USE_SSE_HOOK");f?(await T({session:{refreshToken:f.refreshToken},token:f.accessToken}),v(...u.current)):(l("error"),b())}catch{l("error"),b()}},[R.session.refreshToken]),_=m.useCallback(()=>{c.current&&(!c.current.signal.aborted&&c.current.abort(),l("idle"),i(null),u.current=[])},[]),P=m.useCallback(async()=>{try{const f=await h.execute(R.token);f&&T({usageDetails:f.user})}catch(f){console.error("Error in updating usage details",f)}},[R.token]),x=m.useCallback(()=>{var f;c.current&&(!c.current.signal.aborted&&c.current.abort(),l("idle"),i(null),u.current=[],(f=e.onClose)==null||f.call(e,!0),setTimeout(P,2e3))},[e]),v=m.useCallback(async f=>{var p,L;l("pending"),f&&(u.current=[f]);const j=new AbortController;c.current=j;const $=await F.get("extVersion");try{await te(s,{body:JSON.stringify({...f,...D}),headers:{Authorization:`Bearer ${R.token}`,"Content-Type":"application/json","x-merlin-version":`extension-${$}`},method:e.method,onclose:()=>{var n;(n=e.onClose)==null||n.call(e)},onerror:n=>{var t,g;if((n==null?void 0:n.name)==="CUSTOM_ERROR"&&n.retry)if(O.current<ae)O.current+=1,l("retrying"),(t=e.onRetry)==null||t.call(e),S();else{l("error"),b();try{(g=e.onRetryLimitReached)==null||g.call(e)}catch(I){console.error("Error in onMessage callback passed from component",I)}}throw n},onmessage:n=>{var g,I,K,W,H;const t=JSON.parse(n.data);if((t==null?void 0:t.status)==="error")throw{name:"CUSTOM_ERROR",retry:!1,...t==null?void 0:t.error};if((t==null?void 0:t.status)==="success"){l("streaming");try{(g=e.onMessage)==null||g.call(e,n)}catch(N){console.error("Error in onMessage callback passed from component",N)}}if((t==null?void 0:t.status)==="system"&&(((I=t==null?void 0:t.data)==null?void 0:I.eventType)==="DONE"&&(l("success"),O.current=0),((K=t==null?void 0:t.data)==null?void 0:K.eventType)==="SYSTEM"&&(t!=null&&t.data.hasOwnProperty("usage")&&T({usageDetails:(W=t==null?void 0:t.data)==null?void 0:W.usage}),t!=null&&t.data.hasOwnProperty("questions")||t!=null&&t.data.hasOwnProperty("metadata")||t!=null&&t.data.hasOwnProperty("attachments")||t!=null&&t.data.hasOwnProperty("settings")||t!=null&&t.data.hasOwnProperty("messageType"))))try{(H=e.onMessage)==null||H.call(e,n)}catch(N){console.error("Error in onMessage callback passed from component",N)}},onopen:async n=>{var t;if(n.ok&&n.headers.get("content-type")===U){l("streaming");try{(t=e.onOpen)==null||t.call(e,n)}catch(g){console.error("Error in onOpen callback passed from component",g)}}else{if(n.status===401)throw{name:"CUSTOM_ERROR",retry:!0,...(await n.json()).error};if(n.status===413)throw{message:"Input size too large",name:"CUSTOM_ERROR",retry:!1,type:"INPUT_SIZE_TOO_LARGE"};{const g=await n.json();throw(g==null?void 0:g.status)==="error"?{name:"CUSTOM_ERROR",retry:!1,...g.error}:{message:"Something went wrong. Please try again later.",name:"CUSTOM_ERROR",retry:!1,type:A.UNKNOWN_ERROR}}}},openWhenHidden:!0,signal:j.signal})}catch(n){if((n==null?void 0:n.name)==="CUSTOM_ERROR"){if(n.retry){i(n);return}n.type===A.RATE_LIMITED&&setTimeout(P,100),l("error"),(p=e.onError)==null||p.call(e,n)}else l("error"),(L=e.onError)==null||L.call(e,{message:"Something went wrong. Please try again later.",name:"CUSTOM_ERROR",retry:!1,type:A.UNKNOWN_ERROR})}},[x,R.token,e,D,S]);return m.useMemo(()=>({[r]:{close:x,error:d,execute:v,loading:o==="pending"||o==="retrying",reset:_,setStatus:l,status:o}}),[r,d,x,v,o,_])};export{fe as u};
