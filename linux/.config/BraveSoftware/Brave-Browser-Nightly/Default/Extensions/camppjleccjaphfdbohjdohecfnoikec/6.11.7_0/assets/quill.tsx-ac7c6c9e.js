import{r as s,j as e,R as Z,c as ut}from"./client-45b27fd3.js";import{C as Se,O as ft,m as qe,c as ee,P as pe,a as Ee,L as V,i as ye,Q as mt,n as pt,R as ht,S as Re}from"./index-825701e8.js";import{C as xt}from"./index-24d5af66.js";import{b as te,A as gt}from"./index-37dc4817.js";import{S as re,b as vt,g as bt,C as wt}from"./Combination-d7972bd9.js";import{M as jt}from"./messageContext-827c44b4.js";import{T as yt}from"./themeContext-38ece4f9.js";import{c as Nt,a as Ct}from"./atom-one-light-7372aee1.js";import{g as _e,c as It,E as kt,M as Ne,f as Tt}from"./index-9b1f0f42.js";/* empty css             */import{c as St}from"./tooltip-a6d36cc2.js";import"./i18n-697e4fe6.js";import{P as $e}from"./index-83e03e04.js";import{b as ce,c as Ce,d as de,C as Ie,e as Et,a as we}from"./card-16c0c2c1.js";import{c as M}from"./utils-01642ffa.js";import{b as Rt,u as $t,A as Oe,a as Be}from"./avatar-31868758.js";import{B as A,_ as z,$ as Ue}from"./button-f1c09d10.js";import{D as Lt,a as Pt,b as At,d as Le,e as Mt,c as X,f as Dt,g as Ft,h as qt,$ as Ge,i as _t,j as Ot}from"./dropdown-menu-fa01664b.js";import{L as ze}from"./hook-ae816606.js";import{p as Pe}from"./purify.es-8e338605.js";import{A as Bt,L as Ut}from"./loader-8af8a7e4.js";import{f as q,g as Gt}from"./analytics-46c41402.js";import{g as zt,I as He,o as Ht,s as he,e as Y,u as Qt,t as Vt,F as Kt,a as xe,b as ge,c as ve,d as Ae,f as Me,L as be}from"./form-fccd3825.js";import{u as Wt}from"./useSSE-35954031.js";import{v as G}from"./v4-4a60fe23.js";import{u as Qe}from"./useUserSettings-c0487dc5.js";import{I as Yt}from"./IconPower-207bf3f9.js";import{c as K}from"./createReactComponent-d14705e3.js";import{S as oe,f as Jt,l as Xt,a as Zt,T as Ve,I as es}from"./textarea-392328c1.js";import{B as ie,S as F}from"./skeleton-e68ed841.js";import{u as Ke}from"./useTranslation-c38a45bb.js";import{I as ts}from"./IconCheck-740a5f2a.js";import{I as ss}from"./IconCopy-3f3f64da.js";import{I as as}from"./IconRefresh-c267e433.js";import{I as ns}from"./IconChevronLeft-dc942a4c.js";import{I as rs}from"./IconChevronRight-f54b4a77.js";import{I as De}from"./IconSend-9aa4a715.js";import{m as os,q as is,a as ls}from"./backend-b5a741e2.js";import{I as We}from"./IconX-71686591.js";import{I as cs,a as ds}from"./IconThumbUp-e2c311b9.js";import{$ as Ye,a as us,c as je,d as fs,f as ms}from"./index-9811e1a4.js";import{$ as ke}from"./index-cf2cbbfc.js";import{$ as ps,S as hs,a as xs,b as gs,c as vs,d as Fe}from"./select-70f68a35.js";import{c as bs}from"./index-5c33a703.js";import{P as ws}from"./PersistQueryClientProvider-53edff98.js";import"./index-a24140fc.js";import"./useMutation-24b8df85.js";import"./useAsyncWithPromise-6dde1473.js";var js=K("briefcase","IconBriefcase",[["path",{d:"M3 7m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v9a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z",key:"svg-0"}],["path",{d:"M8 7v-2a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v2",key:"svg-1"}],["path",{d:"M12 12l0 .01",key:"svg-2"}],["path",{d:"M3 13a20 20 0 0 0 18 0",key:"svg-3"}]]),ys=K("message-circle-2","IconMessageCircle2",[["path",{d:"M3 20l1.3 -3.9a9 8 0 1 1 3.4 2.9l-4.7 1",key:"svg-0"}]]),Ns=K("plus","IconPlus",[["path",{d:"M12 5l0 14",key:"svg-0"}],["path",{d:"M5 12l14 0",key:"svg-1"}]]),Cs=K("replace","IconReplace",[["path",{d:"M3 3m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z",key:"svg-0"}],["path",{d:"M15 15m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z",key:"svg-1"}],["path",{d:"M21 11v-3a2 2 0 0 0 -2 -2h-6l3 3m0 -6l-3 3",key:"svg-2"}],["path",{d:"M3 13v3a2 2 0 0 0 2 2h6l-3 -3m0 6l3 -3",key:"svg-3"}]]),Is=K("square-filled","IconSquareFilled",[["path",{d:"M19 2h-14a3 3 0 0 0 -3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3 -3v-14a3 3 0 0 0 -3 -3z",fill:"currentColor",key:"svg-0",strokeWidth:"0"}]]),ks=K("tool","IconTool",[["path",{d:"M7 10h3v-3l-3.5 -3.5a6 6 0 0 1 8 8l6 6a2 2 0 0 1 -3 3l-6 -6a6 6 0 0 1 -8 -8l3.5 3.5",key:"svg-0"}]]);const Ts=o=>s.createElement("svg",{viewBox:"0 0 893 900",fill:"none",xmlns:"http://www.w3.org/2000/svg",...o},s.createElement("g",{clipPath:"url(#clip0_31308_141500)"},s.createElement("path",{d:"M893 450C646.465 450 446.5 248.467 446.5 0C446.5 248.467 246.535 450 0 450C246.535 450 446.5 651.533 446.5 900C446.5 651.533 646.465 450 893 450Z",fill:"url(#paint0_linear_31308_141500)",fillOpacity:.7})),s.createElement("defs",null,s.createElement("linearGradient",{id:"paint0_linear_31308_141500",x1:44.5,y1:277,x2:818.5,y2:652.5,gradientUnits:"userSpaceOnUse"},s.createElement("stop",{stopColor:"#6C3BF9"}),s.createElement("stop",{offset:1,stopColor:"#EFCCFF",stopOpacity:.61})),s.createElement("clipPath",{id:"clip0_31308_141500"},s.createElement("rect",{width:893,height:900,fill:"white"})))),Ss=Rt(o=>({ctx:{obj:{},text:""},liveSelectionActive:!1,quickPrompts:[],requestIdHeader:"",setCtx:n=>o({ctx:n}),setLiveSelectionActive:n=>o({liveSelectionActive:n}),setQuickPrompts:n=>o({quickPrompts:n}),setRequestIdHeader:n=>o({requestIdHeader:n}),setUserInput:n=>o({userInput:n}),userInput:{prompt:""}})),se=o=>$t(Ss,o),Je=s.createContext(null);function Es({children:o}){const{...n}=s.useContext(te),[t]=ze({instance:new _e({area:"local"}),key:"quillSettings"},m=>m===void 0?{bio:"",model:"GPT 3",name:"",occupation:"",outputLang:"english",outputLength:"medium",tone:"empathetic",writingStyle:"professional"}:m),[l,v]=s.useState(null),c=s.useRef(null),u=s.useRef(null),i=s.useRef(null),a=zt(),{ctx:j,setCtx:T,setLiveSelectionActive:C,setRequestIdHeader:b,setUserInput:y}=se(m=>({ctx:m.ctx,setCtx:m.setCtx,setLiveSelectionActive:m.setLiveSelectionActive,setRequestIdHeader:m.setRequestIdHeader,setUserInput:m.setUserInput})),w={onClose:()=>{var m;(m=c.current)==null||m.focus(),a.setIsPromptingAvailable(!0),a.editMessageNodeById(a.getLastMessage().id,x=>(x={...x,status:"SUCCESS"},x))},onError:m=>{if(a.setIsPromptingAvailable(!0),console.error(m),a.deleteLastMessage(),(m==null?void 0:m.name)==="CUSTOM_ERROR")if(m.type===kt.RATE_LIMITED){a.setError(n.usageDetails.type==="PAID"?"Your queries have exhausted. Please upgrade your plan to continue using Merlin.":"Your queries have exhausted for today. Subscribe to Merlin Pro to continue using Merlin or come back tomorrow.");return}else a.setError(m.message||"Something went wrong. Please try again later.");else a.setError("Something went wrong. Please try again later.");const x={description:m.message||"Something went wrong. Please try again later.",duration:3e3,title:"Error",variant:"destructive"};Bt.error(x.title,{description:x.description,duration:x.duration})},onMessage:m=>{var g,L,S,d,P;const x=JSON.parse(m.data),_=x.data.content;((g=x==null?void 0:x.data)==null?void 0:g.eventType)==="SYSTEM"&&(x!=null&&x.data.hasOwnProperty("settings")&&(a.setChatId((S=(L=x==null?void 0:x.data)==null?void 0:L.settings)==null?void 0:S.chatId),a.editMessageNodeById(a.getLastMessage().parentId,k=>(k={...k,id:x.data.settings.userMessage.id},k)),a.editMessageNodeById(a.getLastMessage().id,k=>(k={...k,id:x.data.settings.assistantMessage.id,parentId:x.data.settings.userMessage.id},k))),x!=null&&x.data.hasOwnProperty("questions")&&a.setQuestions((d=x==null?void 0:x.data)==null?void 0:d.questions),(P=x==null?void 0:x.data)!=null&&P.metadata&&a.editMessageNodeById(a.getLastMessage().id,k=>(k={...k,metadata:{...k.metadata,...x.data.metadata}},k))),a.editMessageNodeById(a.getLastMessage().id,k=>(k.status==="LOADING"?(k.content=_,k.role="assistant",k.status="STREAMING"):k.status==="STREAMING"&&(k.content=`${k.content}${_}`),k))},onOpen:async m=>{m.ok&&m.headers.get("X-Request-Id")&&b(m.headers.get("X-Request-Id"))}},{handleSSEQuill:r}=Wt(`${It.DOMAIN}/api/v1/quill?customJWT=true`,"handleSSEQuill",{method:"POST",...w}),I=s.useCallback(m=>{const x=m.prompt.trim().length>=2e4;if(!m.prompt.trim()||x||!a.isPromptingAvailable)return null;C(!1),a.setError("")},[a]),f=()=>{if(u.current){const m=u.current.querySelector("[data-radix-scroll-area-viewport]");m&&setTimeout(()=>m.scrollTo({behavior:"smooth",left:0,top:m.scrollHeight}),100)}},p=s.useCallback(async m=>{var d,P;if(I(m)===null)return;a.setIsPromptingAvailable(!1),r.reset(),a.setQuestions([]),a.appendMessageThread([{attachments:null,content:m.prompt,id:G(),metadata:{context:""},parentId:((d=a.activeThread[a.activeThread.length-1])==null?void 0:d.id)??"root",role:"user",status:"SUCCESS"},{content:"",id:G(),parentId:"",role:"system",status:"LOADING"}]),i.current.setAttribute("merlin-uid",G());const _=Se(),g={ADD_ATTR:["merlin-uid"],FORBID_ATTR:["data-*"],FORBID_TAGS:["style","noscript","script","aside"],USE_PROFILES:{html:!0}},L=Pe.sanitize(_,{...g}),S={message:{attachments:null,content:m.prompt,metadata:{context:j.text??""},parentId:((P=a.activeThread[a.activeThread.length-1])==null?void 0:P.id)??"root",role:"user"},metadata:{contextObj:j.obj,dom:L,domain:window.location.hostname},model:t!=null&&t.model&&(t==null?void 0:t.model)==="GPT 4"?"gpt-4":"gpt-3.5-turbo",thread:a.activeThread};i.current.removeAttribute("merlin-uid"),r.execute(S),a.setContext(null),y({prompt:""}),f(),q({eventName:"SubmitPrompt",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/store/context"})},[a,r,I,y,j,t==null?void 0:t.model]),N=s.useCallback(async()=>{var S;if(I({prompt:a.getLastMessage().content??""})===null)return;a.setIsPromptingAvailable(!1),a.insertMessageNode(a.activeThread[a.activeThread.length-2].id,{content:"",id:G(),parentId:a.activeThread[a.activeThread.length-2].id,role:"system",status:"LOADING"}),i.current.setAttribute("merlin-uid",G());const x=Se(),_={ADD_ATTR:["merlin-uid"],FORBID_ATTR:["data-*"],FORBID_TAGS:["style","noscript","script","aside"],USE_PROFILES:{html:!0}},g=Pe.sanitize(x,{..._}),L={message:{attachments:null,content:a.activeThread[a.activeThread.length-2].content,metadata:{context:j.text??""},parentId:((S=a.activeThread[a.activeThread.length-1])==null?void 0:S.id)??"root",role:"user"},metadata:{contextObj:j.obj,dom:g,domain:window.location.hostname},model:t!=null&&t.model&&(t==null?void 0:t.model)==="GPT 4"?"gpt-4":"gpt-3.5-turbo",thread:a.activeThread.splice(0,a.activeThread.length-2)};i.current.removeAttribute("merlin-uid"),r.execute(L),f(),q({eventName:"RegenerateButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/store/context"})},[I,a,r,j,t==null?void 0:t.model]),E=s.useMemo(()=>(r==null?void 0:r.loading)||(r==null?void 0:r.status)==="streaming",[r==null?void 0:r.loading,r==null?void 0:r.status]),R=s.useMemo(()=>(r==null?void 0:r.status)==="success"||(r==null?void 0:r.status)==="idle",[r==null?void 0:r.status]),O=s.useCallback(()=>{c.current&&(c.current.value=""),a.reset({}),a.setError(""),y({prompt:""}),r.reset(),C(!1),T({obj:{selectedText:""},text:""}),a==null||a.reset({})},[r,a]);s.useEffect(()=>{c.current&&c.current.focus(),(async()=>{const x=await ft();v(x)})()},[]),s.useEffect(()=>{if(!u.current)return;const m=u.current.querySelector("div");if(m&&r.status==="success"){const x=m.scrollHeight,_=m.scrollTop,g=m.offsetHeight;_+g>=x-50&&f()}},[r.status]);const H={chat:a,handleRegenerateLastMessage:N,handleSSEQuill:r,handleSubmit:p,inputRef:c,isSSELoadingOrStreaming:E,isSSESuccessOrIdle:R,quillPrompts:l,scrollAreaRef:u,startNewChat:O,textareaRef:i};return e.jsx(Je.Provider,{value:H,children:o})}function ae(){const o=Z.useContext(Je);if(!o)throw new Error("useQuillContext must be used within a QuillContextProvider");return o}function Xe(o){const{className:n,icon:t}=o;return t==="replace"?e.jsx(Cs,{className:M(n)}):t==="messagecircle2"?e.jsx(ys,{className:M(n)}):t==="tool"?e.jsx(ks,{className:M(n)}):t==="briefcase"?e.jsx(js,{className:M(n)}):t.startsWith("https")?e.jsx("img",{src:t,className:M(n)}):e.jsx(Ns,{className:M(n)})}function J(o){const{item:n,openPortalUi:t}=o;return e.jsx(X,{className:M("cursor-pointer",o.className),onMouseDown:()=>{t({...n.promptConfig})},onClick:()=>q({eventName:n.copy,eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"}),children:e.jsxs("div",{className:"flex w-full items-center gap-2 ",children:[e.jsx(Xe,{icon:n.icon,className:"h-4 w-4 stroke-[1.5]"}),e.jsx("div",{children:n.copy})]})},n.copy)}function Rs(o){var Q;const{isVisible:n,selectedText:t,setIsVisible:l,setModalOpen:v,textarea:c}=o,{ctx:u,setCtx:i,setLiveSelectionActive:a,setUserInput:j,userInput:T}=se(h=>({ctx:h.ctx,requestIdHeader:h.requestIdHeader,setCtx:h.setCtx,setLiveSelectionActive:h.setLiveSelectionActive,setUserInput:h.setUserInput,userInput:h.userInput})),[C,b]=s.useState(!1),{chat:y,handleSubmit:w,inputRef:r,quillPrompts:I}=ae(),[f,p]=s.useState(!1),{...N}=s.useContext(te),[E,R]=Qe(),[O,H]=s.useState(!1),[m,x]=s.useState(0),_=s.useRef(null),g=s.useRef(null);s.useEffect(()=>{const h=()=>{pe(c)?b(!0):b(!1)};return h(),c.addEventListener("keyup",h),()=>{c.removeEventListener("keyup",h)}},[]),s.useEffect(()=>{m>0&&w(T)},[m]);function L(h){const{extractContext:D,extractInput:ct,liveSelection:dt,query:ue}=h;if(!N.isAuthenticated){l(!0);return}const Te=pe(c);let fe="";t?fe=t:ct&&Te&&(fe=Te);const me=fe.slice(-4e3);i({obj:{selectedText:""},text:me}),l(!0),setTimeout(()=>{var ne;(ne=r.current)==null||ne.focus()},20),ue&&j({prompt:ue}),dt&&y.activeThread.length===0&&!me&&a(!0),ue&&me&&x(ne=>ne+1)}function S(){if(!I||!I.dropdownItems)return;const{dropdownItems:h}=I;return t&&h.textSelected&&h.textSelected.length>0?e.jsx(e.Fragment,{children:h.textSelected.map(D=>e.jsx(J,{item:D,openPortalUi:L},D.copy))}):pe(c)?e.jsx(e.Fragment,{children:h.inputContent.map(D=>e.jsx(J,{item:D,openPortalUi:L},D.copy))}):e.jsxs(e.Fragment,{children:[h.context&&h.context.length>0&&e.jsx(e.Fragment,{children:h.context.map(D=>u.text?e.jsx(J,{item:D,openPortalUi:L},D.copy):null)}),h.default&&h.default.length>0&&e.jsx(e.Fragment,{children:h.default.map(D=>e.jsx(J,{item:D,openPortalUi:L},D.copy))})]})}const d=s.useCallback(()=>{g.current&&clearTimeout(g.current),H(!0)},[]),P=s.useCallback(()=>{g.current&&clearTimeout(g.current),g.current=window.setTimeout(()=>{H(!1)},300)},[]),k=s.useCallback(h=>{h.stopPropagation();const D={from:"QUILL",payload:{action:"CLOSE_QUILL_THROUGHT_PAGE",data:null}};window.parent.postMessage(D,"*"),q({eventName:"QuillDisableTemporarily",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[]),B=s.useCallback(h=>{k(h),qe(Ne.QUILL),q({eventName:"QuillDisableForThis",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[k]),$=s.useCallback(h=>{k(h),R("quill"),q({eventName:"QuillDisableForever",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})},[k]),U=s.useCallback(()=>{p(!0)},[]),W=s.useCallback(()=>{p(!1)},[]);return e.jsxs(Lt,{open:O,onOpenChange:h=>{h||H(!1)},modal:!1,children:[(C||n||t)&&e.jsx(Pt,{asChild:!0,onPointerEnter:d,onPointerLeave:P,onPointerDownCapture:h=>{h.preventDefault(),h.stopPropagation()},children:e.jsx("div",{className:M("group/icon flex-center realtive h-5 w-5",{" rounded-full bg-zinc-100":O}),children:e.jsxs("div",{ref:_,className:"flex-center h-full w-full",children:[t&&e.jsx("div",{className:"absolute -right-0 -top-0",children:e.jsxs("span",{className:"relative flex h-1.5 w-1.5",children:[e.jsx("span",{className:"absolute inline-flex h-full w-full animate-ping rounded-full bg-indigo-300 opacity-75"}),e.jsx("span",{className:"relative inline-flex h-1.5 w-1.5 rounded-full bg-indigo-400"})]})}),e.jsx(Ts,{className:"h-4 w-4"})]})})}),e.jsxs(At,{className:"w-56",onPointerEnter:d,onPointerLeave:P,children:[e.jsxs(Le,{children:[S(),e.jsx("div",{className:"merlinExt-magic-btn-border rounded",children:e.jsx(J,{item:{copy:"Custom Prompt",icon:"plus",promptConfig:{extractContext:!0,extractInput:!0,liveSelection:I&&I.textSelectionWithCustomPrompt||!1}},className:"bg-popover",openPortalUi:L})})]}),e.jsxs(e.Fragment,{children:[e.jsx(Mt,{}),e.jsx(Le,{children:e.jsxs(X,{className:"flex justify-between focus:bg-transparent",children:[e.jsxs(Dt,{open:f,onOpenChange:h=>p(h),children:[e.jsx(Ft,{onPointerEnter:U,onPointerLeave:W,onClick:h=>{h.stopPropagation()},hidearrow:"true",children:e.jsx(Yt,{className:"h-4 w-4"})}),e.jsxs(qt,{sticky:"partial",onPointerEnter:U,onPointerLeave:W,children:[e.jsx(X,{className:"hover:bg-accent cursor-pointer",onClick:k,children:"Disable temporarily"}),e.jsx(X,{className:"hover:bg-accent cursor-pointer",onClick:B,children:"Disable for this site"}),e.jsx(X,{className:"hover:bg-accent cursor-pointer",onClick:$,children:"Disable forever"})]})]}),e.jsx(A,{variant:"link",size:"xs",onClick:h=>{!N.isLoading&&N.isAuthenticated?(v(D=>!D),q({eventName:"FeedbackModal",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})):l(!0)},className:"-ml-0.5",children:"Feedback"}),e.jsx(A,{variant:"ghost",size:"icon",onClick:h=>{!N.isLoading&&N.isAuthenticated?(ee("https://www.getmerlin.in/dashboard?from=quill"),q({eventName:"OpenMerlinDashboard",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/dropdown"})):l(!0)},className:"h-fit w-8 p-0 hover:rounded-full",children:e.jsx(Oe,{className:"h-6 w-6",children:e.jsx(Be,{children:((Q=N==null?void 0:N.name)==null?void 0:Q[0])??"U"})})})]})})]})]})]})}function $s(){return e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"flex-center",children:e.jsx(Ce,{className:" font-medium leading-5",children:"You need to be logged in to use this feature. Please login or sign up to continue."})}),e.jsx(de,{className:"flex gap-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{onClick:()=>ee("https://www.getmerlin.in/sign-in"),children:"Login"}),e.jsx(A,{variant:"secondary",onClick:()=>ee("https://www.getmerlin.in/sign-in"),children:"Sign up"})]})})]})}function Ls({handleInsertText:o,index:n,msg:t}){const{t:l}=Ke(),[v,c]=s.useState(!1),{chat:u,handleRegenerateLastMessage:i,isSSESuccessOrIdle:a}=ae(),j=s.useMemo(()=>u.activeThread.length-1===n&&t.role==="assistant",[u.activeThread.length,n,t.role]);function T(C){navigator.clipboard.writeText(C),c(!0),setTimeout(()=>c(!1),1200),q({eventName:"CopyButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/messages"})}if(t.role=="user")return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{zIndex:10+n},className:M("bg-background",{"sticky -top-1 pt-1":n===u.activeThread.length-2}),id:"user-msg-container",children:[e.jsxs("div",{className:" flex gap-2",id:`${n===u.activeThread.length-2?"user-msg-body":""}`,children:[e.jsx(ie,{className:"relative mr-2 h-fit",variant:"secondary",children:l("super_gmail.prompt")}),e.jsx("span",{className:"line-clamp-1 max-h-24 overflow-y-auto break-words text-sm",children:t.content})]},t.id),u.activeThread.length-1!==n&&e.jsx(oe,{className:"my-2"})]})});if(t.role==="assistant")return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative flex min-h-[255px] flex-grow flex-col justify-between",children:[e.jsx("div",{className:" whitespace-pre-wrap break-words p-0 pb-6 text-sm",children:t.content.trim()}),a&&e.jsxs("div",{className:" bg-background flex w-full items-center gap-2 p-0.5 text-sm",children:[e.jsx(A,{size:"sm",variant:"secondary",onClick:()=>{o(t.content)},tabIndex:n===u.activeThread.length-1?0:-1,children:l("super_gmail.insert")}),e.jsx("button",{type:"button",className:"bg-transparent p-1 only:rounded-md",onClick:()=>{T(t.content)},tabIndex:n===u.activeThread.length-1?0:-1,disabled:v,children:v?e.jsx(ts,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"}):e.jsx(ss,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"})}),j&&e.jsx("button",{type:"button",className:"bg-transparent p-1 only:rounded-md",onClick:()=>{i()},tabIndex:n===u.activeThread.length-1?0:-1,children:e.jsx(as,{className:"plain-icon-color h-4 w-4 stroke-[1.5]"})}),t.totSiblings>0&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{type:"button",className:" group/btn bg-transparent",onClick:()=>u.switchLeft(t),disabled:t.idx===0,tabIndex:n===u.activeThread.length-1?0:-1,children:e.jsx(ns,{className:"plain-icon-color h-4 w-4 stroke-[1.5] group-disabled/btn:opacity-50"})}),e.jsxs("span",{className:"mx-0.5 flex items-end",children:[t.idx+1,e.jsx("span",{className:"relative -top-[1px]",children:"/"}),t.totSiblings]}),e.jsx("button",{type:"button",className:" group/btn bg-transparent",onClick:()=>u.switchRight(t),disabled:t.idx===t.totSiblings-1,tabIndex:n===u.activeThread.length-1?0:-1,children:e.jsx(rs,{className:"plain-icon-color h-4 w-4 stroke-[1.5] group-disabled/btn:opacity-50"})})]})]})]}),u.activeThread.length-1!==n&&e.jsx(oe,{className:"my-2"})]});if(t.role==="system")return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:" flex h-[255px] flex-col justify-between",children:e.jsxs("div",{className:"",children:[e.jsx(F,{className:"mb-4 h-2 w-16"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(F,{className:"h-2 w-72"}),e.jsx(F,{className:"h-2 w-32"}),e.jsx(F,{className:"h-2 w-10"}),e.jsx(F,{className:"h-2 w-16"}),e.jsx(F,{className:"h-2 w-96"}),e.jsx(F,{className:"h-2 w-72"}),e.jsx(F,{className:"h-2 w-32"}),e.jsx(F,{className:"h-2 w-10"}),e.jsx(F,{className:"h-2 w-16"}),e.jsx(F,{className:"h-2 w-96"})]}),e.jsx(F,{className:"my-1 mt-4 h-2 w-16"}),e.jsx(F,{className:"h-2 w-20"})]})}),u.activeThread.length-1!==n&&e.jsx(oe,{className:"my-2"})]})}function Ps(o){var f;const{handleInsertText:n,setCurrentMode:t}=o,{chat:l,handleSSEQuill:v,handleSubmit:c,inputRef:u,isSSESuccessOrIdle:i,quillPrompts:a,scrollAreaRef:j}=ae(),{ctx:T,setUserInput:C,userInput:b}=se(p=>({ctx:p.ctx,setUserInput:p.setUserInput,userInput:p.userInput})),y=s.useMemo(()=>(l.activeThread.length>0&&i||l.activeThread.length===0&&T.text.length>5)&&a&&a.quickPrompts,[l.activeThread.length,i,T.text.length,a]),w=Z.useRef(null),[r,I]=Z.useState(-1);return s.useEffect(()=>{w.current&&w.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[r]),e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"h-[320px] w-full p-4 pb-2",children:e.jsx(re,{className:"intersection-observer-root flex flex-1 flex-col",ref:j,children:e.jsxs("div",{className:"mr-2",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("div",{className:"bg-background",id:"context-msg-container",children:[e.jsxs("div",{className:M("flex gap-2",{"flex-col":l.activeThread.length===0}),children:[l.activeThread.length===0?T.text?e.jsx(ie,{className:"relative h-fit w-fit",variant:"secondary",children:"Selected Context"}):e.jsx(ie,{className:"relative h-fit w-fit",variant:"secondary",children:"No context selected"}):e.jsx(ie,{className:"relative h-fit w-fit",variant:"secondary",children:"Context"}),e.jsx(re,{className:M("w-full resize-none text-sm focus-visible:ring-0",{"h-[260px]":l.activeThread.length===0,"h-24":l.activeThread.length>0}),children:T.text?e.jsx("div",{className:"mr-2 h-full whitespace-pre-wrap break-words text-sm ",children:T.text}):e.jsx("div",{className:"tex flex select-none flex-col gap-2",children:e.jsx("ul",{className:"my-2 space-y-2",children:e.jsxs("li",{className:"flex flex-wrap items-center",children:["👈 Please select the text that you want to reply to and press",e.jsx("br",{}),e.jsxs("div",{className:"flex items-center gap-1",children:["the send button",e.jsx(De,{className:"inline h-3 w-3"}),"."]})]})})})})]}),l.activeThread.length>0&&e.jsx(oe,{className:"my-2"})," "]})}),(f=l.activeThread)==null?void 0:f.map((p,N)=>e.jsx(Ls,{msg:p,index:N,handleInsertText:n},p.id)),l.error&&!l.error.includes("Your queries have exhausted")&&e.jsxs("div",{className:"flex min-h-[200px] flex-grow flex-col justify-between px-2 text-red-500",children:[e.jsx("div",{className:"p-0 text-sm",children:l.error}),e.jsx("div",{className:"mt-2 flex items-center gap-2 text-sm",children:e.jsx(A,{onClick:()=>{c({prompt:l.activeThread[l.activeThread.length-1].content}),I(-1)},children:"Retry"})})]}),l.error&&l.error.includes("Your queries have exhausted")&&e.jsxs("div",{className:"flex min-h-[200px] flex-grow flex-col justify-between px-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex",children:[e.jsx("img",{className:"h-8 w-8",src:Ee(Jt),alt:"face-in-cloud"}),e.jsx("img",{className:"h-8 w-8",src:Ee(Xt),alt:"lightning"})]}),e.jsx("div",{className:"p-0 text-sm",children:"Out of queries"})]}),e.jsx("div",{className:"mt-2 flex items-center gap-2 text-sm",children:e.jsx(A,{onClick:()=>ee("https://www.getmerlin.in/pricing?from=quill"),children:"Go Pro"})})]})]})})}),e.jsxs(de,{className:" flex shrink-0 justify-between gap-2 border-t p-4",children:[e.jsxs("div",{className:"relative flex flex-1 items-center",children:[e.jsx(He,{onChange:p=>{I(-1),C({prompt:p.target.value})},value:b.prompt,ref:u,id:"promptInput",placeholder:"Enter your prompt here",autoComplete:"off",onKeyDown:p=>{p.key==="Enter"&&p.shiftKey||p.key==="Enter"&&(p.preventDefault(),c(b),I(-1))},onKeyDownCapture:p=>{if(p.key==="ArrowUp"&&y){if(r===0)return;p.preventDefault(),p.stopPropagation(),I(N=>{const E=N>0?N-1:a.quickPrompts.length-1;return C({prompt:a.quickPrompts[E].prompt}),E})}p.key==="ArrowDown"&&y&&(p.preventDefault(),p.stopPropagation(),I(N=>{const E=N<a.quickPrompts.length-1?N+1:0;return C({prompt:a.quickPrompts[E].prompt}),E}))}}),y&&e.jsx(Ie,{className:"absolute left-0 top-10 w-full rounded-md py-2",children:e.jsx(re,{className:"h-28",children:e.jsx("div",{className:"flex w-full flex-col gap-1 text-sm",children:a.quickPrompts.map((p,N)=>e.jsxs("span",{ref:N===r?w:void 0,onClick:()=>{c({prompt:p.prompt}),I(-1)},className:M("hover:bg-secondary flex cursor-pointer items-center gap-2 px-2 py-1",{"bg-secondary":r===N}),children:[e.jsx(Xe,{icon:p.icon,className:"h-4 w-4 shrink-0  stroke-[1.5]"}),p.copy]},p.copy))})})})]}),i?e.jsx(A,{variant:"outline",size:"icon",className:"flex-center aspect-square ",onClick:()=>{c(b),I(-1)},children:e.jsx(De,{className:"h-4 w-4"})}):e.jsx(A,{size:"icon",variant:"outline",className:"flex-center aspect-square ",onClick:()=>{l.getLastMessage().content==""&&l.deleteLastMessage(),v.close(),q({eventName:"StopGenerationButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/components/messages"})},children:e.jsx(Is,{className:"h-4 w-4 text-rose-500"})}),e.jsx(A,{variant:"outline",size:"icon",className:"flex-center aspect-square ",onClick:()=>{t("SETTINGS")},children:e.jsx(Zt,{className:"h-4 w-4 cursor-pointer"})})]})]})}function As({modalOpen:o,setModalOpen:n}){const[t,l]=s.useState(""),[v,c]=s.useState(""),{chat:u}=ae(),{requestIdHeader:i,userInput:a}=se(b=>({requestIdHeader:b.requestIdHeader,userInput:b.userInput})),j=s.useRef(null);s.useEffect(()=>{const b=y=>{y.key==="Escape"&&o&&n(!1)};return window.addEventListener("keydown",b),()=>{window.removeEventListener("keydown",b)}},[o]);const{...T}=s.useContext(te);async function C(){var w;const y=(((w=u.activeThread)==null?void 0:w.slice(0,u.activeThread.length-1))??[]).map(r=>{var I;return{attachments:((I=r.attachments)==null?void 0:I.map(f=>({type:f.type,url:f.url})))??[],content:r.content,role:r.role}});await os(JSON.stringify({activeChat:y,feature:"QUILL",feedbackMessage:t,userInput:a}),JSON.stringify({generatedResult:"NA"}),v??"negative",window.location.href,T.email??"EMAIL_NOT_FOUND",i)}return e.jsx("div",{className:"fixed left-1/2 top-1/2 z-[1001] h-full max-h-[350px] w-full max-w-[425px] -translate-x-1/2 -translate-y-1/2",ref:j,children:e.jsxs(Ie,{className:"relative flex h-full w-full flex-col justify-between gap-4",children:[e.jsx("div",{className:"absolute -right-4 -top-4",children:e.jsx(A,{variant:"outline",size:"icon",className:"rounded-full",onClick:()=>{n(!1)},children:e.jsx(We,{className:"text-primary/70 h-4 w-4 stroke-[1.5]"})})}),e.jsxs(ce,{className:"flex flex-col gap-2",children:[e.jsx(Ce,{children:"Submit feedback"}),e.jsx(Et,{className:"text-foreground/70 text-sm",children:"Please share what you liked / disliked about this feature"})]}),e.jsx(we,{children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(Ve,{value:t,className:"w-full resize-none",placeholder:"Write your feedback here",onChange:b=>{l(b.target.value)},rows:4}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{variant:"ghost",size:"icon",className:M("p-0",{"bg-primary/10":v==="positive"}),onClick:()=>{c("positive")},children:e.jsx(cs,{className:"text-primary/70 h-4 w-4 stroke-[1.5]"})}),e.jsx(A,{variant:"ghost",size:"icon",className:M("p-0",{"bg-primary/10":v==="negative"}),onClick:()=>{c("negative")},children:e.jsx(ds,{className:"text-primary/70 h-4 w-4 stroke-[1.5]"})})]})]})}),e.jsxs(de,{className:"flex gap-2",children:[e.jsx(A,{variant:"outline",onClick:()=>{l(""),n(!1)},children:"Close"}),e.jsx(A,{variant:"merlin",onClick:()=>{if(!v){n(!1);return}C(),l(""),n(!1)},children:"Submit"})]})]})})}const Ze="Radio",[Ms,et]=Ye(Ze),[Ds,Fs]=Ms(Ze),qs=s.forwardRef((o,n)=>{const{__scopeRadio:t,name:l,checked:v=!1,required:c,disabled:u,value:i="on",onCheck:a,...j}=o,[T,C]=s.useState(null),b=Ue(n,r=>C(r)),y=s.useRef(!1),w=T?!!T.closest("form"):!0;return s.createElement(Ds,{scope:t,checked:v,disabled:u},s.createElement(ke.button,z({type:"button",role:"radio","aria-checked":v,"data-state":tt(v),"data-disabled":u?"":void 0,disabled:u,value:i},j,{ref:b,onClick:je(o.onClick,r=>{v||a==null||a(),w&&(y.current=r.isPropagationStopped(),y.current||r.stopPropagation())})})),w&&s.createElement(Bs,{control:T,bubbles:!y.current,name:l,value:i,checked:v,required:c,disabled:u,style:{transform:"translateX(-100%)"}}))}),_s="RadioIndicator",Os=s.forwardRef((o,n)=>{const{__scopeRadio:t,forceMount:l,...v}=o,c=Fs(_s,t);return s.createElement(fs,{present:l||c.checked},s.createElement(ke.span,z({"data-state":tt(c.checked),"data-disabled":c.disabled?"":void 0},v,{ref:n})))}),Bs=o=>{const{control:n,checked:t,bubbles:l=!0,...v}=o,c=s.useRef(null),u=ps(t),i=ms(n);return s.useEffect(()=>{const a=c.current,j=window.HTMLInputElement.prototype,C=Object.getOwnPropertyDescriptor(j,"checked").set;if(u!==t&&C){const b=new Event("click",{bubbles:l});C.call(a,t),a.dispatchEvent(b)}},[u,t,l]),s.createElement("input",z({type:"radio","aria-hidden":!0,defaultChecked:t},v,{tabIndex:-1,ref:c,style:{...o.style,...i,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function tt(o){return o?"checked":"unchecked"}const Us=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],st="RadioGroup",[Gs,Ja]=Ye(st,[Ge,et]),at=Ge(),nt=et(),[zs,Hs]=Gs(st),Qs=s.forwardRef((o,n)=>{const{__scopeRadioGroup:t,name:l,defaultValue:v,value:c,required:u=!1,disabled:i=!1,orientation:a,dir:j,loop:T=!0,onValueChange:C,...b}=o,y=at(t),w=vt(j),[r,I]=us({prop:c,defaultProp:v,onChange:C});return s.createElement(zs,{scope:t,name:l,required:u,disabled:i,value:r,onValueChange:I},s.createElement(_t,z({asChild:!0},y,{orientation:a,dir:w,loop:T}),s.createElement(ke.div,z({role:"radiogroup","aria-required":u,"aria-orientation":a,"data-disabled":i?"":void 0,dir:w},b,{ref:n}))))}),Vs="RadioGroupItem",Ks=s.forwardRef((o,n)=>{const{__scopeRadioGroup:t,disabled:l,...v}=o,c=Hs(Vs,t),u=c.disabled||l,i=at(t),a=nt(t),j=s.useRef(null),T=Ue(n,j),C=c.value===v.value,b=s.useRef(!1);return s.useEffect(()=>{const y=r=>{Us.includes(r.key)&&(b.current=!0)},w=()=>b.current=!1;return document.addEventListener("keydown",y),document.addEventListener("keyup",w),()=>{document.removeEventListener("keydown",y),document.removeEventListener("keyup",w)}},[]),s.createElement(Ot,z({asChild:!0},i,{focusable:!u,active:C}),s.createElement(qs,z({disabled:u,required:c.required,checked:C},a,v,{name:c.name,ref:T,onCheck:()=>c.onValueChange(v.value),onKeyDown:je(y=>{y.key==="Enter"&&y.preventDefault()}),onFocus:je(v.onFocus,()=>{var y;b.current&&((y=j.current)===null||y===void 0||y.click())})})))}),Ws=s.forwardRef((o,n)=>{const{__scopeRadioGroup:t,...l}=o,v=nt(t);return s.createElement(Os,z({},v,l,{ref:n}))}),rt=Qs,ot=Ks,Ys=Ws,it=s.forwardRef(({className:o,...n},t)=>e.jsx(rt,{className:M("grid gap-2",o),...n,ref:t}));it.displayName=rt.displayName;const le=s.forwardRef(({className:o,...n},t)=>e.jsx(ot,{ref:t,className:M("border-primary text-primary focus-visible:ring-ring aspect-square h-4 w-4 rounded-full border shadow focus:outline-none focus-visible:ring-1 disabled:cursor-not-allowed disabled:opacity-50",o),...n,children:e.jsx(Ys,{className:"flex items-center justify-center",children:e.jsx(bt,{className:"fill-primary h-3.5 w-3.5"})})}));le.displayName=ot.displayName;const Js=Ht({bio:he(),model:Y(["GPT 3","GPT 4"]),name:he(),occupation:he(),outputLang:Y(["english","hindi"]),outputLength:Y(["short","medium","long"]),tone:Y(["empathetic","optimistic","sincere","enthusiastic"]),writingStyle:Y(["professional","casual","neutral"])});function Xs({setCurrentMode:o}){var w,r,I;const{t:n}=Ke(),{...t}=s.useContext(te),[l,v]=Qe(),[c,u]=s.useState(null),[i,a]=ze({instance:new _e({area:"local"}),key:"quillSettings"}),j=Qt({defaultValues:{bio:"",model:"GPT 3",name:"",occupation:"",outputLang:"english",outputLength:"medium",tone:"empathetic",writingStyle:"professional"},resolver:Vt(Js)});s.useEffect(()=>{j.reset(i)},[j,i]);function T(f){a(f),o("CHAT"),q({eventData:{...f,disable:c},eventName:"SaveSettings",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/settings"})}const C=s.useCallback(()=>{const f={from:"QUILL",payload:{action:"CLOSE_QUILL_THROUGHT_PAGE",data:null}};window.parent.postMessage(f,"*")},[]),b=s.useCallback(()=>{C(),qe(Ne.QUILL)},[C]),y=s.useCallback(()=>{C(),v("quill")},[C]);return s.useEffect(()=>{(async()=>{if(!await V.get("quillSettings")){const N=await V.get("gmailPersona");N?V.set("quillSettings",N):V.set("quillSettings",j.getValues())}})()},[]),e.jsxs(we,{className:"flex w-full p-0",children:[e.jsxs("div",{className:"flex  w-12 flex-col items-end justify-between gap-2 border-r p-1 py-2",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsx(A,{variant:"ghost",size:"icon",onClick:()=>{o("CHAT")},children:e.jsx(es,{})})}),e.jsx(A,{variant:"ghost",size:"icon",onClick:()=>ee("https://www.getmerlin.in/dashboard"),children:e.jsx(Oe,{className:"h-6 w-6",children:e.jsx(Be,{children:((I=(r=(w=t.name)==null?void 0:w.split(" "))==null?void 0:r.map(f=>f[0]))==null?void 0:I.join(""))??"U"})})})]}),e.jsx("div",{className:"flex h-[362px] w-full flex-col",children:i?e.jsxs(e.Fragment,{children:[e.jsxs(re,{className:"h-[300px]",children:[e.jsx(ce,{children:e.jsx(Ce,{className:"text-lg",children:n("super_gmail.config")})}),e.jsxs(we,{children:[e.jsx(Kt,{...j,children:e.jsx("form",{onSubmit:j.handleSubmit(T),children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(xe,{control:j.control,name:"model",render:({field:f})=>e.jsxs(ge,{children:[e.jsx(ve,{children:n("super_gmail.ai_model")}),e.jsxs(hs,{onValueChange:f.onChange,value:f.value,children:[e.jsx(xs,{className:"w-full max-w-xs",children:e.jsx(gs,{})}),e.jsxs(vs,{children:[e.jsx(Fe,{value:"GPT 3",children:"GPT 3"}),e.jsx(Fe,{value:"GPT 4",children:"GPT 4"})]})]})]})}),e.jsx("h3",{className:"text-md font-semibold",children:n("super_gmail.persona")}),e.jsx(xe,{control:j.control,name:"name",render:({field:f})=>e.jsxs(ge,{children:[e.jsx(ve,{children:n("super_gmail.name")}),e.jsx(Ae,{children:e.jsx(He,{placeholder:"Your name",...f})}),e.jsx(Me,{})]})}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsx(xe,{control:j.control,name:"bio",render:({field:f})=>e.jsxs(ge,{children:[e.jsx(ve,{children:n("super_gmail.bio")}),e.jsx(Ae,{children:e.jsx(Ve,{placeholder:n("super_gmail.bio_placeholder"),className:"resize-none",...f})}),e.jsx(Me,{})]})})})]})})}),e.jsxs("div",{className:"text-md flex flex-col space-y-2 font-semibold",children:[e.jsx("div",{children:"Disable quill"}),e.jsxs(it,{value:c,onValueChange:f=>u(f.valueOf()),children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(le,{value:"now",id:"now"}),e.jsx(be,{htmlFor:"now",children:"For this session"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(le,{value:"this-site",id:"this-site"}),e.jsx(be,{htmlFor:"this-site",children:"For this site"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(le,{value:"forever",id:"forever"}),e.jsx(be,{htmlFor:"forever",children:"Forever"})]})]})]})]})]}),e.jsx(de,{className:"flex h-[60px] justify-end  gap-2 ",children:e.jsx(A,{onClick:()=>{j.handleSubmit(T)(),c&&(c==="now"?C():c==="this-site"?b():c==="forever"&&y())},children:n("super_gmail.save")})})]}):e.jsx("div",{className:"flex-center h-full",children:e.jsx(Ut,{})})})]})}function Zs(o){const{startNewChat:n,textareaRef:t}=ae(),{liveSelectionActive:l,setCtx:v}=se(g=>({liveSelectionActive:g.liveSelectionActive,setCtx:g.setCtx})),{...c}=s.useContext(te),{relativeDiv:u,textarea:i}=o,a=s.useRef(null),[j,T]=s.useState(!0),[C,b]=s.useState(!1),y=s.useRef(`textarea-${G()}`),w=s.useRef(`quill-portal-${G()}`),[r,I]=s.useState(0),[f,p]=s.useState(0),[N,E]=s.useState(""),[R,O]=s.useState(!1),[H,m]=s.useState("CHAT");function x(g){i&&(i==null||i.focus(),mt(i,g),i==null||i.scrollTo({behavior:"smooth",top:i==null?void 0:i.scrollHeight}),q({eventName:"InsertButton",eventType:"Button",feature:"Quill",firedFromFile:"features/quill/quill"}))}s.useEffect(()=>{t.current=i;const g=()=>{const S=u.getBoundingClientRect(),d=i.getBoundingClientRect();let P=0,k=0;const B=d.height<60,$=24;d.x>=S.x?P=d.x-S.x+d.width-$:d.x+d.width>=S.x&&d.x<=S.x?P=d.x+d.width-S.x-$:P=-(S.x-(d.x+d.width)+$),d.y>=S.y?k=d.y-S.y+d.height-$+(B?$-d.height/2-10:0):d.y+d.height>=S.y&&d.y<=S.y?k=d.y+d.height-S.y-$+(B?$-d.height/2-10:0):k=-(S.y-(d.y+d.height)+$-(B?$-d.height/2-10:0)),I(P),p(k)};g(),i.setAttribute("merlin-id",y.current);const L=new ResizeObserver(g);return L.observe(i),window.addEventListener("resize",g),window.addEventListener("scroll",g),document.addEventListener("scroll",g),window.addEventListener("wheel",g),()=>{L.disconnect(),window.removeEventListener("resize",g),window.removeEventListener("scroll",g),document.removeEventListener("scroll",g),window.removeEventListener("wheel",g)}},[]),s.useEffect(()=>{function g(d){d.key==="Escape"&&(d.preventDefault(),O(!1))}const S=ye(d=>{const P=window.getSelection().toString().trim();P.length>0?l?v({obj:{selectedText:P},text:P}):E(P):E("")},100);return document.addEventListener("selectionchange",S),window.addEventListener("keydown",g),()=>{window.removeEventListener("keydown",g),document.removeEventListener("selectionchange",S)}},[R,l]),s.useEffect(()=>{R||n()},[R]),s.useEffect(()=>{const g=a.current;if(R){const L=d=>{const P=g.closest(".reactAppRoot");if(!P)return;const k=P.parentNode;if(!k||!(k instanceof ShadowRoot))return;const B=k.activeElement,$=g.querySelectorAll('button:not(:disabled), [href], input, select, textarea, [tabindex]:not([tabindex="-1"]):not(:disabled)'),U=Array.from($).indexOf(B),W=$.length-1;if(d.key==="Tab"&&(d.shiftKey&&U===0?(d.preventDefault(),$[W].focus()):!d.shiftKey&&U===$.length-1&&(d.preventDefault(),$[0].focus())),d.key==="ArrowDown"||d.key==="ArrowRight"){if(!B){$[0].focus();return}d.preventDefault();const Q=U+1<$.length?U+1:0,h=$[Q];h&&h.focus()}if(d.key==="ArrowUp"||d.key==="ArrowLeft"){if(!B){$[W].focus();return}d.preventDefault();const Q=U-1>=0?U-1:$.length-1,h=$[Q];h&&h.focus()}},S=d=>{d.key==="Escape"&&O(!1)};return g.addEventListener("keydown",L),g.addEventListener("keydown",S),()=>{g.removeEventListener("keydown",L),g.removeEventListener("keydown",S)}}},[R]),s.useEffect(()=>{const g=L=>{const{data:S}=L;if(S.from&&S.from==="QUILL"){const{payload:d}=S;d&&d.action==="CLOSE_QUILL_THROUGHT_PAGE"&&T(!1)}};return window.addEventListener("message",g),()=>{window.removeEventListener("message",g)}},[]);function _(){return c.isAuthenticated?H==="SETTINGS"?e.jsx(Xs,{setCurrentMode:m}):e.jsx(e.Fragment,{children:e.jsx(Ps,{handleInsertText:x,setCurrentMode:m})}):e.jsx($s,{})}return j?e.jsxs("div",{style:{left:r,position:"absolute",top:f,zIndex:o.zIndex},children:[e.jsx(Rs,{isVisible:R,setModalOpen:b,setIsVisible:O,textarea:i,textareaId:y,selectedText:N}),e.jsx($e,{selector:{mountAsHtmlChild:!0},shouldMount:C,id:"quill-feedback-portal"+w.current,className:"merlin quill-feeback relative",groupBy:"quill-feeback-group",zIndex:2147483646,children:e.jsx(As,{modalOpen:C,setModalOpen:b})}),e.jsx($e,{selector:{mountAsHtmlChild:!0},shouldMount:R,id:w.current,className:"merlin quill-portal-ui relative",groupBy:"quill-portal-ui-group",zIndex:2147483646,children:e.jsxs(Ie,{className:M("fixed flex w-[448px] flex-col justify-between transition-[right] duration-300 ease-in-out",{"select-none":l}),style:{right:20,top:20,zIndex:2147483646},ref:a,children:[e.jsx("div",{className:"bg-secondary absolute -right-3 -top-3 cursor-pointer rounded-full p-1 shadow-lg ",onClick:()=>O(!1),children:e.jsx(We,{className:"h-4 w-4"})}),_()]})})]}):null}const lt=(o,n)=>{let t=n;if(!o)return!0;switch(o.type){case"qs":if(!t.querySelector(o.value))return!1;break;case"parent":t=t.parentElement;break;case"hasClass":if(!t.classList.contains(o.value))return!1;break;case"closest":if(t=t.closest(o.value),!t)return!1;break;case"next":if(t=t.nextElementSibling,!t)return!1;break;case"prev":if(t=t.previousElementSibling,!t)return!1;break;case"firstChild":if(t=t.firstElementChild,!t)return!1;break;case"lastChild":if(t=t.lastElementChild,!t)return!1;break;case"hasId":if(!t.id||t.id!==o.value)return!1;break;case"hasAttribute":if(!t.hasAttribute(o.value))return!1;break}return o.hasOwnProperty("then")?lt(o.then,t):!0};function ea(o){const{blacklistedAttributes:n,mountData:t}=o,[l,v]=Z.useState([]),c=Z.useRef(null);function u(i,a){try{const j=window.location.host,T=i.find(C=>C.host===j);if(T){const{mountingSchema:C}=T;C.forEach(b=>{document.querySelectorAll(b.selector).forEach(w=>{if(w.getAttribute("merlin-id"))return;if(lt(b.condition,w)){try{const I=window.getComputedStyle(w);if(I.visibility==="hidden"||I.display==="none")return;const f=w.getBoundingClientRect();if(f.width<100||f.height<10)return;if(w instanceof HTMLTextAreaElement||w instanceof HTMLInputElement){const p=Array.from(w.attributes).map(E=>E.value),N=Array.from(w.attributes).map(E=>E.name);if(p.some(E=>E.toLowerCase().includes("search"))||N.some(E=>E.toLowerCase().includes("search"))||w.readOnly)return}}catch{return}v(I=>{if(I.some(p=>p.id===w.id))return I;const f=window.getComputedStyle(w);return[...I,{id:G(),ref:w,zIndex:f.zIndex||10}]})}})})}else{const C=document.body.querySelectorAll("textarea"),b=document.body.querySelectorAll('[contenteditable="true"]'),y=document.body.querySelectorAll("input[type=text]:not([name=email])");Array.from(b).concat(Array.from(C)).concat(Array.from(y)).forEach(r=>{try{const f=window.getComputedStyle(r);if(f.visibility==="hidden"||f.display==="none")return;const p=r.getBoundingClientRect();if(p.width<100||p.height<10)return;if(r instanceof HTMLTextAreaElement||r instanceof HTMLInputElement){const N=Array.from(r.attributes).map(R=>R.value),E=Array.from(r.attributes).map(R=>R.name);if(N.some(R=>R.toLowerCase().includes("search"))||E.some(R=>R.toLowerCase().includes("search"))||r.readOnly)return}}catch{return}a.some(f=>r.getAttribute(f.key)===f.value)||r.getAttribute("merlin-id")||v(f=>{if(f.some(N=>N.id===r.id))return f;const p=window.getComputedStyle(r);return[...f,{id:G(),ref:r,zIndex:p.zIndex||10}]})})}}catch{}}return s.useEffect(()=>{u(t,n);const i=new MutationObserver(ye(()=>{u(t,n)},50));return i.observe(document.body,{childList:!0,subtree:!0}),()=>{i.disconnect()}},[]),s.useEffect(()=>{},[l]),e.jsx("div",{className:"relative",ref:c,onMouseEnter:()=>q({eventName:"QuillButton",eventType:"HoverElement",feature:"Quill",firedFromFile:"features/quill/quillWrapper"}),children:l.map(i=>e.jsx(Es,{children:e.jsx(Zs,{textarea:i.ref,relativeDiv:c.current,zIndex:i.zIndex})},i.id))})}const ta=async()=>{await new Promise(o=>{const n=new MutationObserver(ye(()=>{document.body&&(o(),n.disconnect())},50));n.observe(document.documentElement,{childList:!0,subtree:!0})})},sa=async()=>{var f,p;if(await pt(Ne.QUILL))return;const n=await V.get("UserSettings");if(!((f=n==null?void 0:n.quill)!=null&&f.visible))return;const t=await ht();if(!t||!t.visible)return;const l=t.rollout,v=await Gt();if(!v)return;const c=await V.get("authDetails"),u=Re.MD5(v).toString(Re.enc.Hex),i=parseInt(u,16)%100;if(c&&c.isAuthenticated){if(((p=c.usageDetails)==null?void 0:p.type)==="PAID"){if(i>l.authenticated.paid)return}else if(i>l.authenticated.free)return}else if(i>l.unauthenticated)return;const a=window.location.host,j=t.listInUse;if(j==="blacklist"){const N=t.blacklist,E=t.blacklistType;if(E==="contains"&&N.some(R=>a.includes(R))||E==="exact"&&N.some(R=>a===R))return}else if(j==="whitelist"){const N=t.whitelist,E=t.whitelistType;if(E==="contains"&&!N.some(R=>a.includes(R))||E==="exact"&&!N.some(R=>a===R))return}const T=t.shouldUseMount?t.mount:[],C=t.blacklistedAttributes;await ta();const b=document.createElement("merlin-component");b.id="merlin-quill",b.className="merlin textarea-merlin";const y=b.attachShadow({mode:"open"}),w=document.createElement("style");w.textContent=`${bs}
  :host(#merlin-quill) {
  }
  .reactAppRoot {
    all: initial; /* 1st rule so subsequent properties are reset. */
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    position: absolute;
    top: 0;
    left: 0;
    z-index: ${a==="www.reddit.com"?10:2147483645};
  }
  .dark {
      ${Nt}
  }
  ${Ct}
  `.replaceAll(":root",":host"),y.appendChild(w);const r=document.createElement("div");r.id="reactAppRoot",r.className="reactAppRoot",Tt.forEach(N=>{r.addEventListener(N,E=>{E.stopPropagation()})}),document.documentElement.prepend(b),y.appendChild(r),ut(r).render(e.jsx(xt,{children:e.jsx(ws,{client:is,persistOptions:{persister:ls},children:e.jsx(wt,{children:e.jsx(gt,{children:e.jsx(yt,{children:e.jsx(St,{children:e.jsx(jt,{isWebpage:!1,children:e.jsx(ea,{mountData:T,blacklistedAttributes:C})})})})})})})}))};sa();
