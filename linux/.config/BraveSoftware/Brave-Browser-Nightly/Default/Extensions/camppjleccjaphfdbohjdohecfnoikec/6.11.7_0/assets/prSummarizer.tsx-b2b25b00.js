import{r as a,j as e,c as D}from"./client-45b27fd3.js";import{L as d,e as O,c as N,g as W,i as q}from"./index-825701e8.js";import{C as B}from"./index-24d5af66.js";import{g as H}from"./backend-b5a741e2.js";import{C as G}from"./index-00cb779e.js";import{F as L}from"./foyerLogo-7f07d1ff.js";import{a as Q,A as J}from"./index-37dc4817.js";import{a as V,M as Z}from"./messageContext-827c44b4.js";import{T as K}from"./webAccessTooltip-5740d933.js";import{R as X,b as Y,d as ee,A,E as te}from"./index-9b1f0f42.js";import{f as re}from"./analytics-46c41402.js";import{u as oe}from"./useAsyncWithPromise-6dde1473.js";import{u as k}from"./index-e31d72e6.js";import{A as se}from"./index-39fb8d8a.js";import{m as p}from"./motion-2f15212b.js";import{I as ne}from"./IconPower-207bf3f9.js";import{u as ie}from"./useTranslation-c38a45bb.js";import{I as ae}from"./IconUser-ea7f052a.js";import{I as P}from"./IconExclamationCircle-56aaab40.js";import{c as ce}from"./index-5c33a703.js";import"./hook-ae816606.js";import"./v4-4a60fe23.js";import"./index-203ce83a.js";import"./createReactComponent-d14705e3.js";const me=({noOfQueries:o})=>{const r=window.location.origin,t=window.location.pathname.split("/");t.length===6&&t.pop();const s=`${r}${t.join("/")}.diff`,i=`${r}${t.join("/")}.patch`,n=`${r}${t.join("/")}/files`,{updateBlackList:l}=k(),{getFromBackground:c}=a.useContext(V),[z,R]=a.useState(!1),{...w}=a.useContext(Q),{getPrSummary:I}=oe(H,"getPrSummary",!1),[y,f]=a.useState(!1),[j,C]=a.useState(!1),[M,_]=a.useState(null),[h,T]=a.useState(!1),[x,E]=a.useState([]),[v,F]=a.useState(""),U=async(S,g,b=!0)=>{if(!w.isLoading&&w.isAuthenticated&&g)try{E([]);const u=le(window.location.href),m=await I.execute(S,g,u,b,!0);m&&(C(!1),_(null)),E((m==null?void 0:m.diffSummary)??[]),F((m==null?void 0:m.diffTitle)??""),window.location.href===n&&f(!1)}catch(u){f(!1),u.type===te.RATE_LIMITED?T(!0):(C(!0),_(u))}else f(!1)},$=async()=>{re({eventData:window.location.href,eventName:"getPrSummary",eventType:"Button",feature:"Codex",firedFromFile:"components/prSummarizer"}),f(!0);const[S,g]=await Promise.all([c(A.GET_PR_DIFF,"",{url:s}),c(A.GET_PR_PATCH,"",{urlPatch:i})]),b=g.split(`
From `),u=b[b.length-1].split(" ")[0];h||await U(u,S,!1)};return a.useEffect(()=>{h||y&&window.location.href===n||j||x.length&&d&&(d.set(`prSummarizer-${s}`,{lastUpdated:Date.now(),summary:x,title:v}),window.location.href!==n?window.location.href=n:window.parent.postMessage({data:{lastUpdated:Date.now(),summary:x,title:v},type:X.PR_SUMMARIZER},"*"))},[h,j,y,x,v]),e.jsx(e.Fragment,{children:e.jsx(se,{children:e.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"z-50 flex justify-end",children:e.jsxs("div",{onMouseEnter:()=>R(!0),onMouseLeave:()=>R(!1),className:"relative flex w-fit",children:[e.jsx(ue,{handleClick:$,isLoading:y,noOfQueries:o,isAuthenticated:w.isAuthenticated,isError:j,error:M,hasReachedUsageLimit:h}),z&&e.jsx(p.button,{animate:z?{opacity:1}:{opacity:0},initial:{opacity:0},className:"absolute right-0 top-0 z-10 -translate-y-[40%] translate-x-[40%] rounded-full border border-zinc-300/50 bg-zinc-200/50 p-1 text-zinc-600 backdrop-blur-sm dark:border-zinc-600 dark:bg-zinc-800/50 dark:text-zinc-300",type:"button",onClick:()=>{O("COUNT"),l(window.location.hostname)},children:e.jsx(ne,{size:16})})]})})})})};function le(o){const r=new URL(o).hostname,t=new URL(o).pathname.split("/");return t.length===6&&t.pop(),`${r}${t.join("/")}.diff`}const ue=({error:o,handleClick:r,hasReachedUsageLimit:t,isAuthenticated:s,isError:i,isLoading:n,noOfQueries:l})=>{const{t:c}=ie();return s?t?e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",className:"center-with-flex relative mr-1  h-[28px]  cursor-default gap-1 overflow-hidden whitespace-nowrap rounded px-2 py-1 text-sm text-rose-500",children:[e.jsx(P,{size:20,strokeWidth:1.5}),c("pr_summ.out_of_queries")]}),e.jsxs(p.button,{className:"center-with-flex c-transition-colors bg-cornblue-600 font-hanken hover:bg-cornblue-500 group relative gap-2 rounded px-2 py-1 text-sm font-medium text-zinc-100",type:"button",onClick:()=>N(ee+"?from=go-pro-prsummarizer"),children:[e.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:e.jsx(L,{})}),e.jsx("span",{className:"whitespace-nowrap text-sm font-semibold leading-5",children:c("pr_summ.go_pro")})]})]}):e.jsxs(e.Fragment,{children:[i&&e.jsxs("button",{type:"button",className:"center-with-flex relative mr-1  h-[28px]  cursor-default gap-1 overflow-hidden whitespace-nowrap rounded px-2 py-1 text-sm text-rose-500",children:[e.jsx(P,{size:20,strokeWidth:1.5}),c("external_mount.something_wrong")]}),e.jsxs(p.button,{className:"center-with-flex c-transition-colors bg-cornblue-600 font-hanken hover:bg-cornblue-500 group relative gap-2 rounded px-2 py-1 text-sm font-medium text-zinc-100",type:"button",onClick:r,children:[e.jsx("div",{className:`h-5 w-5 ${n?"breathing":""}`,children:e.jsx(L,{})}),n?e.jsxs("div",{className:"flex items-end",children:[e.jsx("div",{className:"mr-1",children:c("external_mount.loading")}),e.jsx(G,{})]}):e.jsx("div",{children:i?"Retry":"Explain PR"}),e.jsxs(K,{position:"bottom",children:[c("pr_summ.will_consume_approx")," ",l," ",c("pr_summ.queries")]})]})]}):e.jsxs(p.button,{className:"center-with-flex c-transition-colors bg-cornblue-600 font-hanken hover:bg-cornblue-500 group relative gap-1 rounded px-2 py-1 text-sm font-medium text-zinc-100",type:"button",onClick:()=>N(Y),children:[e.jsx(ae,{className:"h-4 w-4",strokeWidth:1.5}),e.jsx("div",{children:c("pr_summ.sign_in")})]})},de=o=>{let r="";const t=new MutationObserver(()=>{location.href!==r&&(r=location.href,o())}),s={childList:!0,subtree:!0};t.observe(document.body,s)};function pe({noOfQueries:o}){const{blackList:r,codeSummarizer:t}=k();if(a.useEffect(()=>{d&&d.getAll().then(s=>{for(const i in s)i.includes("prSummarizer")&&Date.now()-JSON.parse(s[i]).lastUpdated>2*60*1e3&&d.remove(i)})},[]),t&&!r.includes(window.location.hostname))return e.jsx(B,{children:e.jsx(Z,{children:e.jsx(J,{children:e.jsx(me,{noOfQueries:o})})})})}const fe=async()=>{const o=await W();if(o&&(!o.misc.codeSummarizer.visible||o.misc.codeSummarizer.blackListedDomains.includes(window.location.hostname)))return;const r=()=>{document.body&&new MutationObserver(q(()=>{var n;const s=document.querySelector(".gh-header-actions"),i=document.querySelector(".tabnav-tabs.d-flex.overflow-auto > a:last-child > #files_tab_counter").textContent;((n=s.firstChild)==null?void 0:n.id)!=="merlin-pr-summarizer"&&he(l=>{s.prepend(l)},i)},50)).observe(document.body,{attributes:!0,childList:!0,subtree:!0})};r(),de(()=>{r()})},he=async(o,r)=>{const t=document.createElement("merlin-component");t.id="merlin-pr-summarizer",t.className="merlin-pr-summarizer";const s=t.attachShadow({mode:"open"}),i=document.createElement("style");i.textContent=`${ce}
:host(#merlin-pr-summarizer) {
    all: initial; /* 1st rule so subsequent properties are reset. */
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
.reactAppRoot{
    z-index: 1 !important;
}
`;const n=document.createElement("div");n.id="reactAppRoot",n.className="reactAppRoot",s.appendChild(i),s.appendChild(n),o(t),D(n).render(e.jsx(pe,{noOfQueries:r}))};fe();
